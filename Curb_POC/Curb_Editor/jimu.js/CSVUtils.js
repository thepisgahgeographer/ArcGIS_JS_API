// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("exports dojo/_base/lang dojo/_base/array dojo/_base/html dojo/_base/kernel dojo/has dojo/number dojo/Deferred jimu/utils esri/lang esri/tasks/QueryTask esri/tasks/query esri/graphic jimu/ArcadeUtils".split(" "),function(f,t,r,x,A,v,B,u,w,C,D,E,F,G){function y(c){var a=t.clone(c.attributes);(c=c.geometry)&&"point"===c.type&&("x"in a?a._x=c.x:a.x=c.x,"y"in a?a._y=c.y:a.y=c.y);return a}f.exportCSV=function(c,a,b){return f._createCSVStr(a,b).then(function(d){return f._download(c+".csv",d)})};
f.exportCSVFromFeatureLayer=function(c,a,b){b=b||{};return f._getExportData(a,{datas:b.datas,objectIds:b.objectIds,fromClient:b.fromClient,withGeometry:b.withGeometry,outFields:b.outFields,filterExpression:b.filterExpression,outSpatialReference:b.outSpatialReference,arcadeExpressions:b.arcadeExpressions,geometry:b.geometry,orderByFields:b.orderByFields,start:b.start,num:b.num}).then(function(d){return f._formattedData(a,d,{formatNumber:b.formatNumber,formatDate:b.formatDate,formatCodedValue:b.formatCodedValue,
richText:{clearFormat:b.richTextFieldsToClear&&!!b.richTextFieldsToClear.length,fieldsToClear:b.richTextFieldsToClear||[]},popupInfo:b.popupInfo}).then(function(k){return f.exportCSV(c,k.datas,k.columns)})})};f.exportCSVByAttributes=function(c,a,b,d){d=t.mixin({},d);d.datas=b;return f.exportCSVFromFeatureLayer(c,a,d)};f.exportCSVByGraphics=function(c,a,b,d){b=r.map(b,function(k){return k.attributes});return f.exportCSVByAttributes(c,a,b,d)};f._createCSVStr=function(c,a){var b=new u,d="",k=0,e=0,g=
"",h="",m=","===B.format(1.1,{locale:A.locale}).substring(1,2)?";":",";try{a=r.map(a,function(n){return"string"===typeof n?{name:n}:n});r.forEach(a,function(n){n=n.alias||n.name;-1<n.toString().indexOf(m)&&(n='"'+n+'"');d=d+g+n;g=m});d+="\r\n";k=c.length;e=a.length;for(var l=0;l<k;l++){g="";for(var q=0;q<e;q++){(h=c[l][a[q].name])||"number"===typeof h||(h="");if("string"===typeof h){var p=!1;(p=";"===m?/[";\r\n]/g.test(h):/[",\r\n]/g.test(h))&&(h='"'+h.replace(/(")/g,'""')+'"')}d=d+g+h;g=m}d+="\r\n"}b.resolve(d)}catch(n){console.error(n),
b.resolve("")}return b};f._isIE11=function(){return 11===w.has("ie")};f._isEdge=function(){return w.has("edge")};f._getDownloadUrl=function(c){return window.Blob&&window.URL&&window.URL.createObjectURL?(c=new Blob(["\ufeff"+c],{type:"text/csv"}),URL.createObjectURL(c)):"data:attachment/csv;charset\x3dutf-8,\ufeff"+encodeURIComponent(c)};f._download=function(c,a){var b=new u;try{if(v("ie")&&10>v("ie")){var d=window.top.open("about:blank","_blank");d.document.write("sep\x3d,\r\n"+a);d.document.close();
d.document.execCommand("SaveAs",!0,c);d.close()}else if(10===v("ie")||f._isIE11()||f._isEdge()){var k=new Blob(["\ufeff"+a],{type:"text/csv"});navigator.msSaveBlob(k,c)}else{var e=x.create("a",{href:f._getDownloadUrl(a),target:"_blank",download:c},document.body);if(v("safari")){var g=document.createEvent("MouseEvents");g.initEvent("click",!0,!0);e.dispatchEvent(g)}else e.click();x.destroy(e)}b.resolve()}catch(h){b.reject(h)}return b};f._getExportData=function(c,a){var b=new u,d=null,k=[],e=a.datas,
g=a.withGeometry,h=!!a.arcadeExpressions;d=a.outFields;d&&d.length||(d=c.fields);d=t.clone(d);if(g&&!(e&&0<e.length)){h?(k=r.filter(c.fields,function(l){return-1===l.name.indexOf("expression/")}),k=t.clone(k)):k=t.clone(d);var m="";m=-1!==d.indexOf("x")?"_x":"x";d.push({name:m,alias:m,format:{digitSeparator:!1,places:6},show:!0,type:"esriFieldTypeDouble"});m=-1!==d.indexOf("y")?"_y":"y";d.push({name:m,alias:m,format:{digitSeparator:!1,places:6},show:!0,type:"esriFieldTypeDouble"})}e&&0<e.length?(h&&
(e=f._getAttrsWithExpressionsBatch(e,a.arcadeExpressions)),b.resolve({data:e||[],outFields:d})):a.fromClient?(e=r.map(c.graphics,function(l){l=g?y(l):t.clone(l);return l=h?f._getAttrsWithExpressions(l,a.arcadeExpressions):l}),b.resolve({data:e||[],outFields:d})):f._getExportDataFromServer(c,k,a).then(function(l){h&&(l=f._getAttrsWithExpressionsBatch(l,a.arcadeExpressions));b.resolve({data:l||[],outFields:d})});return b};f._getExportDataFromServer=function(c,a,b){var d=new u;if("esri.layers.FeatureLayer"!==
c.declaredClass)return d.resolve([]),d;var k=new D(c.url),e=new E;e.where=b.filterExpression||c.getDefinitionExpression&&c.getDefinitionExpression()||"1\x3d1";0<a.length?(c=r.map(a,function(g){return g.name}),e.outFields=c):e.outFields=["*"];e.objectIds=b.objectIds;e.returnGeometry=b.withGeometry;e.outSR=b.spatialReference;e.geometry=b.geometry;e.orderByFields=b.orderByFields;e.start=b.start;e.num=b.num;e.outSpatialReference=b.outSpatialReference;k.execute(e,function(g){g=r.map(g.features,function(h){return y(h)});
d.resolve(g)},function(g){console.error(g);d.resolve([])});return d};f._formattedData=function(c,a,b){var d=new u,k=[],e=a.data;a=a.outFields;for(var g=0,h=e.length;g<h;g++){for(var m={},l=0;l<a.length;l++){var q=a[l];m[q.name]=f._getExportValue(e[g],q,c,b)}k.push(m)}c=r.map(a,function(p){return{alias:p.alias,name:p.name}});d.resolve({datas:k,columns:c});return d};f._getExportValue=function(c,a,b,d){function k(q){if(h&&C.isDefined(h.fieldInfos))for(var p=0,n=h.fieldInfos.length;p<n;p++){var z=h.fieldInfos[p];
if(z.fieldName===q)return z.format}return null}function e(q){for(var p=0,n=m.length;p<n;p++)if(m[p].fieldName===q)return!0;return!1}var g=c[a.name],h=d.popupInfo,m=d.richText.fieldsToClear,l="esriFieldTypeDate"===a.type&&d.formatDate;e="esriFieldTypeString"===a.type&&d.richText.clearFormat&&e(a.name);if(l)return w.fieldFormatter.getFormattedDate(g,k(a.name));if(e)return g?(c=document.createElement("span"),c.innerHTML=g,c.textContent||c.innerText||""):g;g=w.getDisplayValueForCodedValueOrSubtype(b,
a.name,c);return g.isCodedValueOrSubtype?g.displayValue:c[a.name]};f._getAttrsWithExpressions=function(c,a){var b=t.getObject("expressionInfos",!1,a);a=t.getObject("layerDefinition",!1,a);var d=new F(null,null,c);return G.customExpr.getAttributesFromCustomArcadeExpr(b,d,a)||c};f._getAttrsWithExpressionsBatch=function(c,a){var b=[];return b=r.map(c,function(d){return f._getAttrsWithExpressions(d,a)})}});