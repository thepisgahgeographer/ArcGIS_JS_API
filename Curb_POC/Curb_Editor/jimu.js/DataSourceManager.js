// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/topic dojo/Evented dojo/when ./utils jimu/LayerInfos/LayerInfos jimu/portalUtils jimu/portalUrlUtils jimu/filterUtils esri/tasks/query esri/tasks/QueryTask esri/tasks/StatisticDefinition ./Query".split(" "),function(x,e,k,h,y,p,q,t,z,A,B,v,w,C,D){var r=null,u=x(y,{constructor:function(){this._listeners=[];this._refreshTimers=[];this._dataStore={};this._jimuQueryObject={};this._dataSourceUsage={};this._itemsFilter={};this.filterUtils=
new B;window.isBuilder?(h.subscribe("app/mapLoaded",e.hitch(this,this._onMapLoaded)),h.subscribe("app/mapChanged",e.hitch(this,this._onMapChanged))):(h.subscribe("mapLoaded",e.hitch(this,this._onMapLoaded)),h.subscribe("mapChanged",e.hitch(this,this._onMapChanged)));window.isBuilder?(h.subscribe("app/appConfigLoaded",e.hitch(this,this._onAppConfigLoaded)),h.subscribe("app/appConfigChanged",e.hitch(this,this._onAppConfigChanged))):(h.subscribe("appConfigLoaded",e.hitch(this,this._onAppConfigLoaded)),
h.subscribe("appConfigChanged",e.hitch(this,this._onAppConfigChanged)));h.subscribe("updateDataSourceData",e.hitch(this,this._onUpdataDataSourceData));window.isBuilder&&h.subscribe("app/dataSourceDataUpdated",e.hitch(this,this._onDataSourceDataUpdatedInApp))},getData:function(a){return this._dataStore[a]},getDataSourceConfig:function(a){return this.appConfig.dataSource.dataSources[a]},parseDataSourceId:function(a){var b=a.split("~"),c={};if(2>b.length)return console.error("Bad data source id:",a),
c;switch(b[0]){case "map":return b=a.lastIndexOf("~"),c={from:"map",layerId:a.substring(4,b)};case "widget":return c={from:"widget",widgetId:b[1]};case "external":return c={from:"external"};default:console.error("Bad data source id:",a)}},addDataSourceUsage:function(a,b){this._dataSourceUsage[a]?(0>this._dataSourceUsage[a].indexOf(b)&&this._dataSourceUsage[a].push(b),1===this._dataSourceUsage[a].length&&this._startOneDataSource(this.appConfig.dataSource.dataSources[a])):(this._dataSourceUsage[a]=
[b],this._startOneDataSource(this.appConfig.dataSource.dataSources[a]))},removeDataSourceUsage:function(a,b){this._dataSourceUsage[a]&&0<=this._dataSourceUsage[a].indexOf(b)&&(this._dataSourceUsage[a]=k.filter(this._dataSourceUsage[a],function(c){return c!==b}))},_onUpdataDataSourceData:function(a,b){this.appConfig.dataSource.dataSources[a]?"widget"!==this.parseDataSourceId(a).from?console.error("Please update data source from widget only.",a):this._updateDataSourceData(a,b):console.error("Not found data source id:",
a)},_updateDataSourceData:function(a,b){this._dataStore[a]=b;h.publish("dataSourceDataUpdated",a,b);this.emit("update",a,b)},_onDataSourceDataUpdatedInApp:function(a,b){this._updateDataSourceData(a,b)},_onMapLoaded:function(a){this.map=a;window.isBuilder||this._handleDataSourceConfigChange(this.appConfig,this.appConfig,"mapLoaded")},_onMapChanged:function(a){this.map=a;window.isBuilder||this._handleDataSourceConfigChange(this.appConfig,this.appConfig,"mapChanged")},_onAppConfigLoaded:function(a){this.appConfig=
e.clone(a)},_onAppConfigChanged:function(a,b){a=e.clone(a);window.isBuilder||("dataSourceChange"===b?this._handleDataSourceConfigChange(this.appConfig,a,b):"mapChange"===b&&this._cleanForConfigChangedDataSource(this.appConfig,a));this.appConfig=a},_handleDataSourceConfigChange:function(a,b,c){a&&(this._removeListeners(),this._removeTimers(),this._cleanForConfigChangedDataSource(a,b));k.forEach(Object.keys(b.dataSource.dataSources),function(f){b.dataSource.dataSources[f].idObj=this.parseDataSourceId(f)},
this);this._listenDataSourceChange(b.dataSource.dataSources);this._startRefreshTimer(b.dataSource,c);this._initStaticDataSource(b.dataSource)},_cleanForConfigChangedDataSource:function(a,b){var c=a.dataSource.dataSources,f=b.dataSource.dataSources;k.forEach(Object.keys(c),function(d){if(!f[d]||f[d]&&!q.isEqual(f[d],c[d]))delete this._jimuQueryObject[d],this._updateDataSourceData(d,{features:[]}),delete this._dataStore[d]},this)},_isGlobalRefresh:function(a){return a.unifiedRefreshInterval&&0<a.unifiedRefreshInterval},
_startOneDataSource:function(a){var b=this._isGlobalRefresh(this.appConfig.dataSource.settings)?this.appConfig.dataSource.settings.unifiedRefreshInterval:a.refreshInterval;if("map"===a.idObj.from)this._listenMapDataSourceChange(a);else if("external"===a.idObj.from&&a.filterByExtent){var c={};c.handle=this.map.on("extent-change",e.hitch(this,this._onLayerDataChange,a));c.dsId=a.id;this._listeners.push(c)}if("map"===a.idObj.from||"external"===a.idObj.from)this._refeshDataSource(a),a.isDynamic&&(c={},
c.handle=setInterval(e.hitch(this,this._refeshDataSource,a),6E4*b),c.dsId=a.id,this._refreshTimers.push(c))},_stopAndCleanOneDataSource:function(a){this._listeners=k.filter(this._listeners,function(b){return b.dsId===a.id?(b.handle.remove(),!1):!0},this);this._refreshTimers=k.filter(this._refreshTimers,function(b){return b.dsId===a.id?(clearInterval(b.handle),!1):!0},this);this._updateDataSourceData(a.id,{features:[]})},_listenDataSourceChange:function(a){k.forEach(Object.keys(a),function(b){b=a[b];
if("map"===b.idObj.from)this._listenMapDataSourceChange(b);else if("external"===b.idObj.from&&b.filterByExtent){var c={};c.handle=this.map.on("extent-change",e.hitch(this,this._onLayerDataChange,b));c.dsId=b.id;this._listeners.push(c)}},this)},_listenMapDataSourceChange:function(a){this._getLayerObject(a.idObj.layerId).then(e.hitch(this,function(b){if(b){var c={};c.handle=b.on("edits-complete",e.hitch(this,this._onLayerDataChange,a));c.dsId=a.id;this._listeners.push(c);c={};c.handle=this._getLayerInfo(a.idObj.layerId).on("filterChanged",
e.hitch(this,this._onLayerDataChange,a));c.dsId=a.id;this._listeners.push(c);a.filterByExtent&&(c={},c.handle=this.map.on("extent-change",e.hitch(this,this._onLayerDataChange,a)),c.dsId=a.id,this._listeners.push(c))}else console.error("Can not find layer that data source depends on.",a.id)}))},_onLayerDataChange:function(a){this._doQueryForDataSource(a)},_doQueryForDataSource:function(a){("config"===this.appConfig.mode||this._dataSourceUsage[a.id]&&0!==this._dataSourceUsage[a.id].length)&&this.doQuery(a).then(e.hitch(this,
function(b){this._updateDataSourceData(a.id,{features:b.features})}))},_getLayerObject:function(a){return(a=t.getInstanceSync().getLayerOrTableInfoById(a))?a.getLayerObject():p(null)},_getLayerInfo:function(a){return t.getInstanceSync().getLayerOrTableInfoById(a)},_startRefreshTimer:function(a,b){var c=a.dataSources,f=a.settings;k.forEach(Object.keys(c),function(d){d=c[d];if("widget"!==d.idObj.from&&d.isDynamic&&d.url){var l=this._isGlobalRefresh(f)?f.unifiedRefreshInterval:d.refreshInterval;"dataSourceChange"===
b?("external"===d.idObj.from||"map"===d.idObj.from)&&this._refeshDataSource(d):"external"===d.idObj.from&&this._refeshDataSource(d);d={handle:setInterval(e.hitch(this,this._refeshDataSource,d),6E4*l),dsId:a.id};this._refreshTimers.push(d)}},this)},_initStaticDataSource:function(a){k.forEach(Object.keys(a.dataSources),function(b){b=a.dataSources[b];"widget"!==b.idObj.from&&!b.isDynamic&&b.url&&this._doQueryForDataSource(b)},this)},_refeshDataSource:function(a){this._doQueryForDataSource(a)},_getDataSourceFilter:function(a){if("map"===
a.idObj.from){var b=t.getInstanceSync().getLayerOrTableInfoById(a.idObj.layerId),c;b&&(c=b.getFilter());b=a.filter?this._getFilterExpr(a.filter,a.url):"1\x3d1";var f=c?"("+c+") and ("+b+")":b;return p(f)}return"external"===a.idObj.from?a.portalUrl&&a.itemId?this._getFilterFromItem(a.portalUrl,a.itemId,a.url).then(e.hitch(this,function(d){var l=a.filter?this._getFilterExpr(a.filter,a.url):"1\x3d1";return f=d?"("+d+") and ("+l+")":l})):p(a.filter?this._getFilterExpr(a.filter,a.url):"1\x3d1"):p(a.filter?
this._getFilterExpr(a.filter,a.url):"1\x3d1")},_getFilterExpr:function(a,b){return this.filterUtils.hasVirtualDate(a)?(this.filterUtils.isHosted=q.isHostedService(b),this.filterUtils.getExprByFilterObj(a)):a.expr},_getFilterFromItem:function(a,b,c){var f=A.getItemUrl(a,b);if(this._itemsFilter[f])return p(this._itemsFilter[f]);var d=z.getPortal(a);return d.getItemById(b).then(e.hitch(this,function(l){return"Feature Service"!==l.type?this._itemsFilter[f]=null:d.getItemData(b).then(e.hitch(this,function(g){var n=
c.split("/"),m=n.pop();m||(m=n.pop());if(!g.layers)return this._itemsFilter[f]=null;g=g.layers.filter(function(E){return E.id+""===m})[0];return g&&g.layerDefinition?this._itemsFilter[f]=g.layerDefinition.definitionExpression:this._itemsFilter[f]=null}))}))},doQuery:function(a){a.idObj||(a.idObj=this.parseDataSourceId(a.id));this.emit("begin-update",a.id);return this._getQueryObjectFromDataSource(a).then(e.hitch(this,function(b){if("Features"===a.type){if("serviceLimitation"===a.resultRecordType){var c=
b;var f=new w(a.url);return f.execute(c)}var d=this._jimuQueryObject[a.id];!d||d.url===a.url&&q.isEqual(d.query.toJson(),b.toJson())||(delete this._jimuQueryObject[a.id],d=null);d||(d={},d.url=a.url,d.query=b,"all"!==a.resultRecordType&&(d.pageSize=a.resultRecordCount),d=new D(d),this._jimuQueryObject[a.id]=d);return"all"===a.resultRecordType?d.getAllFeatures():d.queryByPage(1)}f=new w(a.url);c=new v;return this._getDataSourceFilter(a).then(e.hitch(this,function(l){c.where=l;a.filterByExtent&&(c.geometry=
this.map.extent);a.dataSchema.groupByFields&&0<a.dataSchema.groupByFields.length&&(c.groupByFieldsForStatistics=a.dataSchema.groupByFields);a.dataSchema.orderByFields&&0<a.dataSchema.orderByFields.length&&(c.orderByFields=a.dataSchema.orderByFields);c.outStatistics=a.dataSchema.statistics.map(function(g){var n=g.onStatisticField+"_"+g.statisticType;"count"===g.statisticType&&(n="STAT_COUNT");n=q.upperCaseString(n);var m=new C;m.statisticType=g.statisticType;m.onStatisticField=g.onStatisticField;m.outStatisticFieldName=
n;return m});return f.execute(c)}))}))},_getQueryObjectFromDataSource:function(a){return this._getDataSourceFilter(a).then(e.hitch(this,function(b){var c=new v;c.where=b;a.filterByExtent&&(c.geometry=this.map.extent);c.outFields=a.dataSchema.fields.map(function(f){return f.name});a.dataSchema.orderByFields&&0<a.dataSchema.orderByFields.length&&(c.orderByFields=a.dataSchema.orderByFields);c.returnGeometry=!0;c.outSpatialReference=this.map.spatialReference;return p(c)}))},_removeListeners:function(){this._listeners.forEach(e.hitch(this,
function(a){a.handle.remove()}));this._listeners=[]},_removeTimers:function(){this._refreshTimers.forEach(e.hitch(this,function(a){clearInterval(a.handle)}));this._refreshTimers=[]}});u.getInstance=function(){null===r&&(r=new u,window._datasourceManager=r);return r};return u});