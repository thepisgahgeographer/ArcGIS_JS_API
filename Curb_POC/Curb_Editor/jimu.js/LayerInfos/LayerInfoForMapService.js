// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/array dojo/_base/lang dojo/Deferred dojo/json dojo/aspect dojo/topic ./LayerInfo esri/request esri/layers/FeatureLayer esri/lang".split(" "),function(u,h,l,n,v,p,q,w,r,x,m){return u(w,{_legendInfo:null,_sublayerIdent:null,controlPopupInfo:null,_jsapiLayerInfos:null,_oldFilter:null,_subLayerVisible:null,constructor:function(){},init:function(){this._initJsapiLayerInfos();this._initSubLayerVisible();this._initSubLayerIdent();this._initControlPopup();this.inherited(arguments);
this._initAfterRootLayerInfo();this._needToRefresh().then(l.hitch(this,function(a){a&&(this.update(),this._getLayerInfosObj()._onLayersUpdated(this,this))}))},_initAfterRootLayerInfo:function(){this.traversal(function(a){!a.isRootLayer()&&a._initAfterRootLayerInfo&&a._initAfterRootLayerInfo()})},_needToRefresh:function(){var a=new n;this.layerObject.dynamicLayerInfos&&this.isRootLayer()&&this.isItemLayer()&&!this.originOperLayer.thematicGroup?this.getItemInfo().then(l.hitch(this,function(b){(b=(b=
b.getItemData())&&b.thematicGroup)?(this.originOperLayer.thematicGroup=b,a.resolve(!0)):a.resolve(!1)})):a.resolve(!1);return a},_initOldFilter:function(){this._oldFilter=this.layerObject&&this.layerObject.layerDefinitions?this.layerObject.layerDefinitions:[]},_initJsapiLayerInfos:function(){var a=h.filter(this.originOperLayer.layers,function(b){return m.isDefined(b.id)&&m.isDefined(b.name)&&m.isDefined(b.minScale)&&m.isDefined(b.maxScale)&&m.isDefined(b.parentLayerId)&&m.isDefined(b.defaultVisibility)});
this._jsapiLayerInfos=this.layerObject.dynamicLayerInfos?this.originOperLayer.thematicGroup&&this.originOperLayer.thematicGroup.layerIds&&0<=this.originOperLayer.thematicGroup.layerIds.length?h.filter(this.layerObject.dynamicLayerInfos,function(b){return-1<this.originOperLayer.thematicGroup.layerIds.indexOf(b.id)?!0:!1},this):this.layerObject.dynamicLayerInfos:0<a.length?a:this.layerObject.layerInfos},_cloneInfoTemplates:function(a){var b={},d;for(d in a)if(a.hasOwnProperty(d)&&"function"!==typeof a[d]){var c=
a[d];c.infoTemplate&&c.infoTemplate.toJson&&(b[d]={infoTemplate:new c.infoTemplate.constructor(c.infoTemplate.toJson()),layerUrl:c.layerUrl,resourceInfo:c.resourceInfo})}return b},_initControlPopup:function(){this.controlPopupInfo={enablePopup:void 0,infoTemplates:this._cloneInfoTemplates(this.layerObject.infoTemplates)};this.layerObject._infoTemplates=this._cloneInfoTemplates(this.layerObject.infoTemplates);p.after(this.layerObject,"setInfoTemplates",l.hitch(this,function(){this.layerObject._infoTemplates=
this._cloneInfoTemplates(this.layerObject.infoTemplates);this.controlPopupInfo.infoTemplates=this._cloneInfoTemplates(this.layerObject.infoTemplates);this.traversal(function(a){a._afterSetInfoTemplates&&a._afterSetInfoTemplates()})}))},_initSubLayerIdent:function(){this._sublayerIdent={definitions:{},empty:!0,defLoad:new n}},_initSubLayerVisible:function(a){this._subLayerVisible={};for(var b=0;b<this._jsapiLayerInfos.length;b++)this._subLayerVisible[this._jsapiLayerInfos[b].id]=!1;a?h.forEach(a,function(d){this._subLayerVisible[d]=
!0},this):this.originOperLayer.visibleLayers?h.forEach(this.originOperLayer.visibleLayers,function(d){this._subLayerVisible[d]=!0},this):h.forEach(this._jsapiLayerInfos,function(d){d.defaultVisibility&&(this._subLayerVisible[d.id]=!0)},this)},_initVisible:function(){this._visible=this.originOperLayer.layerObject.visible},_setTopLayerVisible:function(a){this.originOperLayer.layerObject.setVisibility(a);this._visible=a},_setSubLayerVisible:function(a){var b=[-1,-1,-1],d=[],c=h.filter(this.originOperLayer.layerObject.visibleLayers,
function(k){return-1!==k});h.forEach(c,function(k){if(!this._isGroupLayerBySubId(k)){var t=this._subLayerInfoIndex[k];t&&t._isAllSubLayerVisibleOnPath()&&d.push(k)}},this);c=d;for(var e in a)if(a.hasOwnProperty(e)&&"function"!==typeof a[e]){var f=Number(e);if(a[e]){var g=h.indexOf(c,f);0>g&&c.push(f)}else g=h.indexOf(c,f),0<=g&&c.splice(g,1)}b=b.concat(c);this.originOperLayer.layerObject.setVisibleLayers(b)},_resetLayerObjectVisiblity:function(a){var b=a?a[this.id]:null,d=!1;if(a&&(b&&this.layerObject.setVisibility(b.visible),
"esri.layers.ArcGISDynamicMapServiceLayer"===this.layerObject.declaredClass)){b={};for(var c in a)a.hasOwnProperty(c)&&"function"!==typeof a[c]&&(d=!0,b[c]=a[c].visible);d&&this._setSubLayerVisibleByCheckedInfo(b)}},_setSubLayerVisibleByCheckedInfo:function(a){var b=[];h.forEach(this._jsapiLayerInfos,function(c){var e=this.id+"_"+c.id;m.isDefined(a[e])?a[e]&&b.push(c.id):this._subLayerVisible[c.id]&&b.push(c.id)},this);this._initSubLayerVisible(b);this.traversal(function(c){c._initVisible()});var d=
{};this.traversal(function(c){0!==c.getSubLayers().length||c.isRootLayer()||(d[c.originOperLayer.mapService.subId]=c._isAllSubLayerVisibleOnPath())});this._setSubLayerVisible(d)},_subLayerVisibleChanged:function(){var a=[];this.traversal(function(b){a.push(b)});q.publish("layerInfos/layerInfo/visibleChanged",a)},obtainNewSubLayers:function(){var a=[],b=this.originOperLayer.layerObject,d=null;d="esri.layers.ArcGISDynamicMapServiceLayer"===b.declaredClass?"dynamic":"tiled";h.forEach(this._jsapiLayerInfos,
function(e){this._addNewSubLayer(a,b.url+"/"+e.id,b.id+"_"+e.id,e,e.subLayerIds&&0<e.subLayerIds.length?d+"_group":d)},this);var c=[];h.forEach(this._jsapiLayerInfos,function(e,f){e=e.parentLayerId;if(-1!==e){for(var g=null,k=0;k<a.length;k++)if(a[k].mapService.subId===e){g=a[k];break}(e=g)&&e.subLayers.push(a[f])}},this);h.forEach(this._jsapiLayerInfos,function(e,f){-1===e.parentLayerId&&(e=this._layerInfoFactory.create(a[f]),c.push(e),e.init())},this);return c},_addNewSubLayer:function(a,b,d,c,
e){var f=c.source&&c.source.mapLayerId;if(void 0===f||null===f)f=c.id;var g=this.getMSShipFeatureLayer(b,c.id);a.push({layerObject:{url:b,empty:!0},title:c.name||c.id||" ",id:d||"-",subId:c.id,subLayers:[],mapService:{layerInfo:this,subId:c.id,mapServiceSubId:f},selfType:g?"mapservice_"+e+"_ship_featurelayer":"mapservice_"+e,msShipFLayerId:g&&g.id,parentLayerInfo:this})},_handleErrorSubLayer:function(a,b,d,c,e,f){a[b]={layerObject:null,title:f.name||f.id||" ",id:d||" ",subLayers:[],mapService:{layerInfo:this,
subId:c}}},getMSShipFeatureLayer:function(a,b){var d=null,c=a.indexOf("/MapServer");if(-1<c){var e=this.map.graphicsLayerIds.map(l.hitch(this,function(g){return this.map.getLayer(g)})),f=a.substring(0,c+1);e.some(l.hitch(this,function(g){var k=g.url;return k&&-1<k.indexOf(f+"FeatureServer/"+b)&&g&&!g.empty&&g.mode===x.MODE_SELECTION&&!l.getObject("_wabProperties.isMSOwnedFeatureLayer",!1,g)?(d=g,!0):!1}))}return d},getLegendInfo:function(a){var b=new n;this._legendInfo?b.resolve(this._legendInfo):
this._legendRequest(a).then(l.hitch(this,function(d){this._legendInfo=d.layers;b.resolve(this._legendInfo)}),function(){b.reject()});return b},_legendRequest:function(a){return 10.01<=this.layerObject.version?this._legendRequestServer():this._legendRequestTools(a)},_legendRequestServer:function(){var a=this.layerObject.url+"/legend",b={f:"json"};this.layerObject._params.dynamicLayers&&(b.dynamicLayers=v.stringify(this._createDynamicLayers(this.layerObject)),"[{}]"===b.dynamicLayers&&(b.dynamicLayers=
"[]"));return r({url:a,content:b,handleAs:"json",callbackParamName:"callback"})},_legendRequestTools:function(a){return r({url:a+"sharing/tools/legend?soapUrl\x3d"+this.layerObject.url,content:{f:"json"},handleAs:"json",callbackParamName:"callback"})},_createDynamicLayers:function(a){var b=[],d;h.forEach(a.dynamicLayerInfos||a.layerInfos,function(c){d={id:c.id};d.source=c.source&&c.source.toJson();var e;a.layerDefinitions&&a.layerDefinitions[c.id]&&(e=a.layerDefinitions[c.id]);e&&(d.definitionExpression=
e);var f;a.layerDrawingOptions&&a.layerDrawingOptions[c.id]&&(f=a.layerDrawingOptions[c.id]);f&&(d.drawingInfo=f.toJson());d.minScale=c.minScale||0;d.maxScale=c.maxScale||0;b.push(d)});return b},_getServiceDefinition:function(){var a=this.getUrl();return this._serviceDefinitionBuffer.getRequest(this.subId).request(a)},_getSubserviceDefinition:function(a){return 10.11<=this.layerObject.version?this._getAllLayerAndTable(a):this._getLayerAndTable(a)},_getAllLayerAndTable:function(a){var b=this.layerObject.url+
"/layers",d=this._serviceDefinitionBuffer.getRequest("_all_layer_and_table_request");d.isResolved()||d.request(b).then(l.hitch(this,function(c){c||(c={layers:[]});this.traversal(l.hitch(this,function(e){if(!e.isRootLayer()){var f=e.originOperLayer.mapService.mapServiceSubId;e=this._serviceDefinitionBuffer.getRequest(f);var g=null;h.some(c.layers,function(k){if(k.id===f)return g=k,!0},this);e.setResponse(g)}}))}));return this._serviceDefinitionBuffer.getRequest(a).fakeRequest()},_getLayerAndTable:function(a){var b=
this.layerObject.url+"/"+a;return this._serviceDefinitionBuffer.getRequest(a).request(b)},_getSublayerSettingOfWebmap:function(a){var b=h.filter(this.originOperLayer.layers,function(d){return d.id===a});return 1===b.length?b[0]:null},_getSublayerShowLegendOfWebmap:function(a){return(a=this._getSublayerSettingOfWebmap(a))?void 0!==a.showLegend?a.showLegend:!0:!0},_idIsInJsapiLayerInfos:function(a){return null===this._getJsapiLayerInfoById(a)?!1:!0},_getJsapiLayerInfoById:function(a){for(var b=null,
d=0;d<this._jsapiLayerInfos.length;d++)if(this._jsapiLayerInfos[d].id===a){b=this._jsapiLayerInfos[d];break}return b},_isGroupLayerBySubId:function(a){return(a=this._getJsapiLayerInfoById(a))&&a.subLayerIds&&0<a.subLayerIds.length?!0:!1},_bindEvent:function(){this.inherited(arguments);if(this.layerObject&&!this.layerObject.empty){var a=this.layerObject.on("visible-layers-change",l.hitch(this,this._onVisibleLayersChanged));this._eventHandles.push(a);a=p.after(this.layerObject,"setLayerDefinitions",
l.hitch(this,this._onFilterChanged));this._eventHandles.push(a)}},_onVisibleLayersChanged:function(a){var b=a.visibleLayers;if(-1===b[0]&&-1===b[1]&&-1===b[2])this._subLayerVisibleChanged(),this._isShowInMapChanged2();else{a=[];var d=[-1,-1,-1];b=this._converVisibleLayers(b);a=b.visibleLayersForUpdateSubLayerVisible;d=d.concat(b.visibleLayersForSetVisibleLayers);this._initSubLayerVisible(a);this.traversal(function(c){c._initVisible()});this.layerObject.setVisibleLayers(d)}},_converVisibleLayers:function(a){var b=
{visibleLayersForUpdateSubLayerVisible:[],visibleLayersForSetVisibleLayers:[]};h.forEach(a,function(d){var c=this.findLayerInfoById(this.id+"_"+d);if(this._isGroupLayerBySubId(d))c.traversal(function(e){a.push(e.originOperLayer.mapService.subId)});else for(;c&&c.originOperLayer.mapService;)a.push(c.originOperLayer.mapService.subId),c=c.parentLayerInfo},this);h.forEach(a,function(d){0<=d&&0>b.visibleLayersForUpdateSubLayerVisible.indexOf(d)&&b.visibleLayersForUpdateSubLayerVisible.push(d)},this);h.forEach(b.visibleLayersForUpdateSubLayerVisible,
function(d){this._isGroupLayerBySubId(d)||b.visibleLayersForSetVisibleLayers.push(d)},this);return b},_onFilterChanged:function(){for(var a,b=[],d=this.layerObject.layerDefinitions,c=d.length>this._oldFilter.length?d.length:this._oldFilter.length,e=0;e<c;e++)(d[e]?d[e]:null)!==(this._oldFilter[e]?this._oldFilter[e]:null)&&(a=this.findLayerInfoById(this.id+"_"+e))&&a.isLeaf()&&b.push(a);0<b.length&&(q.publish("layerInfos/layerInfo/filterChanged",b,l.getObject("_wabProperties.objectPassWithFilterChangeEvent",
!0,this.layerObject)),this._oldFilter=d,l.setObject("_wabProperties.objectPassWithFilterChangeEvent",{},this.layerObject))}})});