// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/Deferred dojo/_base/lang dojo/_base/array dojo/topic dojo/on esri/layers/FeatureLayer esri/layers/GraphicsLayer esri/geometry/geometryEngine esri/graphic esri/Color esri/symbols/SimpleMarkerSymbol esri/symbols/SimpleLineSymbol esri/symbols/SimpleFillSymbol".split(" "),function(y,u,h,k,m,z,l,A,q,n,r,v,w,x){var p=null,t=y(null,{constructor:function(){window.isBuilder?(m.subscribe("app/mapLoaded",h.hitch(this,this._onMapLoaded)),m.subscribe("app/mapChanged",h.hitch(this,
this._onMapChanged))):(m.subscribe("mapLoaded",h.hitch(this,this._onMapLoaded)),m.subscribe("mapChanged",h.hitch(this,this._onMapChanged)))},_displayLayers:{},previousMapScale:null,setSelectionSymbol:function(a){var b=a.geometryType,f=new v(v.STYLE_CIRCLE,16,null,r.fromArray([0,255,255])),c=new w(w.STYLE_SOLID,r.fromArray([0,255,255]),2),d=new x(x.STYLE_SOLID,c,r.fromArray([0,255,255,.3]));"esriGeometryPoint"===b?a.setSelectionSymbol(f):"esriGeometryPolyline"===b?a.setSelectionSymbol(c):"esriGeometryPolygon"===
b&&a.setSelectionSymbol(d)},updateSelectionByFeatures:function(a,b,f){0<b.length&&(b=k.map(b,h.hitch(this,function(d){var g=null;g=0<=a.graphics.indexOf(d)?new n(d.toJson()):d;g.wabIsTemp=!0;return g})));a.getSelectionSymbol()||this.setSelectionSymbol(a);var c=new u;a._selectHandler({features:b},f,null,null,c);this._isLayerNeedDisplayLayer(a)&&(this._displayLayers[a.id]||(this._displayLayers[a.id]=this._createDisplayLayer(a)),this._updateDisplayLayer(a,b,f));return c},getDisplayLayer:function(a){return this._displayLayers[a]},
setSelection:function(a,b){return this.updateSelectionByFeatures(a,b,l.SELECTION_NEW)},addFeaturesToSelection:function(a,b){return this.updateSelectionByFeatures(a,b,l.SELECTION_ADD)},removeFeaturesFromSelection:function(a,b){return this.updateSelectionByFeatures(a,b,l.SELECTION_SUBTRACT)},clearSelection:function(a){var b=new u;this.clearDisplayLayer(a);a.clearSelection();b.resolve();return b},clearDisplayLayer:function(a){(a=this._displayLayers[a.id])&&a.clear()},getClientFeaturesByGeometry:function(a,
b,f){return k.filter(a.graphics,h.hitch(this,function(c){return c.geometry?f?q.contains(b,c.geometry):q.intersects(b,c.geometry):!1}))},getUnionGeometryBySelectedFeatures:function(a){var b=null;a=a.getSelectedFeatures();0<a.length&&(b=k.map(a,h.hitch(this,function(f){return f.geometry})),b=q.union(b));return b},_createDisplayLayer:function(a){var b=new A,f=a.objectIdField;b.fields=a.fields;b.id="displayLayer_of_"+a.id;this.map.addLayer(b);if(!this.map.spatialReference.equals(a.spatialReference)||
a.hasWebGLSurface()){var c=a.getSelectionSymbol();z(a,"update-end",h.hitch(this,function(){var d=Math.round(this.map.getScale());if(this.previousMapScale!==d&&b.graphics&&0<b.graphics.length){this.previousMapScale=d;var g=k.map(b.graphics,function(e){return e.attributes[f]});d=k.filter(a.graphics,function(e){return 0<=g.indexOf(e.attributes[f])});b.clear();k.forEach(d,h.hitch(this,function(e){e=new n(e.toJson());e.setSymbol(c);b.add(e)}))}}))}return b},_updateDisplayLayer:function(a,b,f){var c=this._displayLayers[a.id],
d=a.getSelectionSymbol();a.hasWebGLSurface()?this._updateDisplayLayerWebGL(a,c,d,b,f):(b=a.getSelectedFeatures(),this.clearDisplayLayer(a),k.forEach(b,h.hitch(this,function(g){g.visible&&(g.setSymbol(null),g=new n(g.toJson()),g.setSymbol(d),c.add(g))})))},_updateDisplayLayerWebGL:function(a,b,f,c,d){d===l.SELECTION_NEW&&(a._selectedFeaturesWebGL={});d===l.SELECTION_NEW||d===l.SELECTION_ADD?k.forEach(c,h.hitch(this,function(e){e.visible&&(a._selectedFeaturesWebGL[e.attributes[a.objectIdField]]=e)})):
d===l.SELECTION_SUBTRACT&&k.forEach(c,h.hitch(this,function(e){e=e.attributes[a.objectIdField];e in a._selectedFeaturesWebGL&&delete a._selectedFeaturesWebGL[e]}));this.clearDisplayLayer(a);for(var g in a._selectedFeaturesWebGL)c=new n(a._selectedFeaturesWebGL[g].toJson()),c.setSymbol(f),b.add(c)},_isLayerNeedDisplayLayer:function(a){return a.hasWebGLSurface()||!a.getMap()},_onMapLoaded:function(a){this.map=a},_onMapChanged:function(a){this.map=a}});t.getInstance=function(){p||(p=new t,window._selectionManager=
p);return p};return t});