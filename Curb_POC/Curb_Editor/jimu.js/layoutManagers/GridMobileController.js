// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/html dojo/on dojo/aspect dojo/dom-construct dojo/dom-geometry dojo/dom-class dijit/_WidgetBase dijit/_TemplatedMixin jimu/PanelManager jimu/WidgetManager jimu/utils".split(" "),function(r,e,k,n,m,p,l,q,g,t,u,v,w,x){return r([t,u],{baseClass:"jimu-dnd-mobile-controller",templateString:'\x3cdiv\x3e\x3cdiv class\x3d"icon-section" data-dojo-attach-point\x3d"iconNode"\x3e\x3c/div\x3e\x3cdiv class\x3d"container-section" data-dojo-attach-point\x3d"containerNode"\x3e\x3c/div\x3e\x3c/div\x3e',
appConfig:null,panelContainerNode:null,openIds:null,toolsCount:0,panels:null,openPanelIds:null,widgetOnCloseHandlerIds:null,panelOnCloseHandlerIds:null,postCreate:function(){this.inherited(arguments);this.panelManager=v.getInstance();this.widgetManager=w.getInstance();this.openIds=[];this.openPanelIds=[];this.widgetOnCloseHandlerIds=[];this.panelOnCloseHandlerIds=[];this.panels={};this.createWidgetIcons();this.destroyUnusedPanels();0===this.toolsCount&&n.setStyle(this.domNode,"display","none");this.own(m(this.iconNode,
"click",e.hitch(this,function(a){a.stopPropagation();g.contains(this.containerNode,"in")?(g.remove(this.containerNode,"in"),g.add(this.containerNode,"out")):(g.remove(this.containerNode,"out"),g.add(this.containerNode,"in"))})));this.own(m(document.body,"click",e.hitch(this,function(a){g.contains(this.containerNode,"in")&&!this.isPartOfPopup(a.target||a.srcElement)&&(g.remove(this.containerNode,"in"),g.add(this.containerNode,"out"))})))},_isPanelUsed:function(a){var c;k.some(this.appConfig.widgetOnScreen.widgets,
e.hitch(this,function(d){if(d.inPanel&&a===d.id+"_panel")return c=d,!0}));return c},destroyUnusedPanels:function(){for(var a=[],c,d,b=0;b<this.panelManager.panels.length;b++)c=this.panelManager.panels[b].id,(d=this._isPanelUsed(c))?this.panelManager.panels[b].reloadWidget(d):a.push(c);k.forEach(a,e.hitch(this,function(h){this.panelManager.destroyPanel(h)}))},destroyOnScreenWidgets:function(){k.forEach(this.appConfig.widgetOnScreen.widgets,function(a){a.inPanel?this.panelManager.destroyPanel(a.id+
"_panel"):this.widgetManager.destroyWidget(a.id)},this)},isPartOfPopup:function(a){var c=this.containerNode;return a===c||n.isDescendant(a,c)},setConfig:function(a){this.appConfig=a;this.createWidgetIcons()},createWidgetIcons:function(){this.toolsCount=0;l.empty(this.containerNode);this.appConfig&&this.appConfig.widgetOnScreen&&k.forEach(this.appConfig.widgetOnScreen.widgets,function(a){a.uri&&a.closeable&&(this._addItem(a),this.toolsCount++)},this)},_pushId:function(a){this._popId(a);this.openPanelIds.push(a)},
_popId:function(a,c){a=this.openPanelIds.indexOf(a);0<=a&&(this.openPanelIds.splice(a,1),c&&0<this.openPanelIds.length&&(c=this.openPanelIds[this.openPanelIds.length-1],this.panelManager.openPanel(c)))},_addItem:function(a){var c=e.clone(a),d=l.create("div",{"class":"row"},this.containerNode);l.create("div",{"class":"widget-icon column",style:"background: url("+a.icon+") no-repeat;"},d);l.create("div",{"class":"widget-label jimu-ellipsis column",title:a.label,innerHTML:x.sanitizeHTML(a.label)},d);
this.own(m(d,"click",e.hitch(this,function(b){b.stopPropagation();if(a.inPanel){b=q.getMarginBox(this.panelContainerNode);var h=window.isRTL?{relativeTo:"browser",right:b.l,top:b.t,width:b.w,height:b.h}:{relativeTo:"browser",left:b.l,top:b.t,width:b.w,height:b.h};c.panel={uri:"themes/DashboardTheme/panels/OnScreenPanel/Panel",position:h};this.panelManager.showPanel(c).then(e.hitch(this,function(f){this.panels[f.id]=f;this._pushId(f.id);f.setPosition(h);0>this.panelOnCloseHandlerIds.indexOf(f.id)&&
(this.own(p.after(f,"onClose",e.hitch(this,function(){this._popId(f.id,!0)}))),this.panelOnCloseHandlerIds.push(f.id));return f})).then(e.hitch(this,function(f){this.panelManager.openPanel(f)}))}else b=q.getMarginBox(d),this._toggleOffPanelWidget(a,b.l+b.w,b.t);g.remove(this.containerNode,"in");g.add(this.containerNode,"out")})))},_toggleOffPanelWidget:function(a,c,d){var b=this.openIds.indexOf(a.id);0<=b?(this.widgetManager.closeWidget(a.id),this.openIds.splice(b,1)):this.widgetManager.loadWidget(a).then(e.hitch(this,
function(h){this.openIds.push(a.id);h.setPosition({left:c,top:d,zIndex:100,relativeTo:"map"});this.widgetManager.openWidget(h);0>this.widgetOnCloseHandlerIds.indexOf(a.id)&&(this.own(p.after(h,"onClose",e.hitch(this,function(){b=this.openIds.indexOf(a.id);0<=b&&this.openIds.splice(b,1)}))),this.widgetOnCloseHandlerIds.push(a.id))}))},setPanelPosition:function(a){k.forEach(this.openPanelIds,e.hitch(this,function(c,d){d===this.openPanelIds.length-1&&(a.zIndex=101);"opened"!==this.panels[c].state&&"active"!==
this.panels[c].state||this.panels[c].setPosition(a,!0)}))}})});