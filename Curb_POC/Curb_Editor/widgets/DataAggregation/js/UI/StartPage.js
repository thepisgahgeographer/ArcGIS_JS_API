// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
require({cache:{"url:widgets/DataAggregation/js/UI/templates/StartPage.html":'\x3cdiv class\x3d"pad-left-5 no-select"\x3e\r\n  \x3ctable class\x3d"page-table" cellpading\x3d"0"\x3e\r\n    \x3ctbody\x3e\r\n\r\n      \x3ctr\x3e\r\n        \x3ctd colspan\x3d"3" class\x3d"panel-title-td"\x3e\r\n          \x3cdiv class\x3d"panel-title-text" tabindex\x3d"0" role\x3d"region"\r\n            aria-label\x3d"${nls.startPage.locationAndField} ${nls.startPage.locationAndFieldHint}"\x3e\r\n            ${nls.startPage.locationAndField}\r\n          \x3c/div\x3e\r\n        \x3c/td\x3e\r\n      \x3c/tr\x3e\r\n      \x3ctr class\x3d"bottom-border-bold task-instruction-row"\x3e\r\n        \x3ctd colspan\x3d"3" class\x3d"panel-title-hint-td"\x3e\r\n          \x3cdiv class\x3d"instruction" data-dojo-attach-point\x3d"locationAndFieldHint"\x3e\r\n            ${nls.startPage.locationAndFieldHint}\r\n          \x3c/div\x3e\r\n        \x3c/td\x3e\r\n      \x3c/tr\x3e\r\n\r\n      \x3ctr class\x3d"task-instruction-row"\x3e\r\n        \x3ctd colspan\x3d"3" class\x3d"field-control-td"\x3e\r\n          \x3cdiv class\x3d"panel-title-text"\x3e${nls.startPage.targetLayerLabel}\x3c/div\x3e\r\n        \x3c/td\x3e\r\n      \x3c/tr\x3e\r\n\r\n      \x3ctr class\x3d"bottom-border-bold task-instruction-row"\x3e\r\n        \x3ctd colspan\x3d"3" class\x3d"panel-title-hint-td"\x3e\r\n          \x3cdiv class\x3d"esriCTTargetLayerParent"\x3e\r\n            \x3cdiv class\x3d"esriCTTargetLayerSelector" aria-label\x3d"${nls.startPage.targetLayerLabel}" style\x3d"width: 100%;"\r\n              data-dojo-attach-point\x3d"targetLayerSelector" data-dojo-type\x3d"jimu/dijit/formSelect"\x3e\x3c/div\x3e\r\n          \x3c/div\x3e\r\n        \x3c/td\x3e\r\n      \x3c/tr\x3e\r\n\r\n      \x3ctr class\x3d"task-row" data-dojo-attach-event\x3d"onClick:_locationMappingClick , onkeydown:_locationMappingClick"\r\n        tabindex\x3d"0" role\x3d"button" aria-label\x3d"${nls.mapping.locationMapping} ${nls.mapping.locationMappingHint}"\x3e\r\n        \x3ctd class\x3d"field-control-td"\x3e\r\n          \x3cdiv class\x3d"task-text"\x3e${nls.mapping.locationMapping}\x3c/div\x3e\r\n        \x3c/td\x3e\r\n        \x3ctd class\x3d"width-15"\x3e\r\n          \x3cdiv class\x3d"jimu-icon jimu-icon-error incomplete-mark" data-dojo-attach-point\x3d"locationMappingComplete" title\x3d"${nls.startPage.mappingErrorMsg}"\x3e\r\n          \x3c/div\x3e\r\n        \x3c/td\x3e\r\n        \x3ctd class\x3d"width-15"\x3e\r\n          \x3cdiv class\x3d"next-arrow float-right next-arrow-img"\x3e\r\n          \x3c/div\x3e\r\n        \x3c/td\x3e\r\n      \x3c/tr\x3e\r\n      \x3ctr class\x3d"bottom-border task-instruction-row"\x3e\r\n        \x3ctd colspan\x3d"3" class\x3d"instruction-padding"\x3e\r\n          \x3cdiv class\x3d"instruction"\x3e${nls.mapping.locationMappingHint}\x3c/div\x3e\r\n        \x3c/td\x3e\r\n      \x3c/tr\x3e\r\n\r\n      \x3ctr class\x3d"task-row" data-dojo-attach-point\x3d"fieldMappingRow" data-dojo-attach-event\x3d"onClick:_schemaMappingClick , onkeydown:_schemaMappingClick"\r\n        tabindex\x3d"0" role\x3d"button" aria-label\x3d"${nls.mapping.schemaMapping} ${nls.mapping.schemaMappingHint}"\x3e\r\n        \x3ctd class\x3d"field-control-td"\x3e\r\n          \x3cdiv class\x3d"task-text"\x3e${nls.mapping.schemaMapping}\x3c/div\x3e\r\n        \x3c/td\x3e\r\n        \x3ctd class\x3d"width-15"\x3e\r\n          \x3cdiv class\x3d"jimu-icon jimu-icon-error incomplete-mark" data-dojo-attach-point\x3d"fieldMappingComplete" title\x3d"${nls.startPage.mappingErrorMsg}"\x3e\r\n          \x3c/div\x3e\r\n        \x3c/td\x3e\r\n        \x3ctd class\x3d"width-15"\x3e\r\n          \x3cdiv class\x3d"next-arrow float-right next-arrow-img"\x3e\x3c/div\x3e\r\n        \x3c/td\x3e\r\n      \x3c/tr\x3e\r\n      \x3ctr class\x3d"bottom-border pad-top-10 task-instruction-row"\x3e\r\n        \x3ctd colspan\x3d"3" class\x3d"instruction-padding"\x3e\r\n          \x3cdiv class\x3d"instruction"\x3e${nls.mapping.schemaMappingHint}\x3c/div\x3e\r\n        \x3c/td\x3e\r\n      \x3c/tr\x3e\r\n    \x3c/tbody\x3e\r\n  \x3c/table\x3e\r\n\r\n  \x3cdiv class\x3d"pad-top-10"\x3e\r\n    \x3cdiv class\x3d"jimu-btn float-right display-none" data-dojo-attach-point\x3d"addToMapButton"\r\n      data-dojo-attach-event\x3d"onClick:_addToMapClick , onkeydown:_addToMapClick" tabindex\x3d"0" aria-label\x3d"${nls.buttons.addToMap}" role\x3d"button"\x3e\r\n      ${nls.buttons.addToMap}\x3c/div\x3e\r\n    \x3cdiv class\x3d"float-right bg-loading-img bg-loading pad-top-10 display-none" data-dojo-attach-point\x3d"progressNode"\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e'}});
define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/on dojo/Deferred dojo/keys dijit/_WidgetBase dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dojo/Evented dojo/text!./templates/StartPage.html dojo/dom-class dojo/query esri/lang ./Review jimu/LayerInfos/LayerInfos jimu/utils jimu/dijit/formSelect".split(" "),function(x,f,p,r,w,n,y,z,A,B,C,g,D,I,E,F,G){return x([y,z,A,B],{baseClass:"cf-startpage",declaredClass:"CriticalFacilities.StartPage",templateString:C,_started:null,label:"StartPage",
parent:null,nls:null,map:null,appConfig:null,config:null,theme:"",styleColor:"",state:"mapping",csvStore:null,_syncFields:{},singleEnabled:!1,multiEnabled:!1,xyEnabled:!1,constructor:function(a){f.mixin(this,a)},postCreate:function(){this.inherited(arguments);F.getInstance(this.map,this.map.itemInfo).then(f.hitch(this,function(a){this.operLayerInfos=a;this.populateTargetLayerSelector();this.own(r(this.targetLayerSelector,"change",f.hitch(this,function(b){this.emit("targetLayerChanged",b)})))}))},
startup:function(){this._started=!0;this.pageContainer.backDisabled=0<this.pageContainer._backLabels.length?!1:!0;this.updateImageNodes();this.lastFocusNode=this.fieldMappingRow},populateTargetLayerSelector:function(){var a=this.config.layerSettings,b=[];a&&a.layerInfo&&a.layerInfo.featureLayer&&(a=[a]);for(var d=0;d<a.length;d++){var c;a[d]&&a[d].layerInfo&&a[d].layerInfo.featureLayer&&(c=this.operLayerInfos.getLayerInfoById(a[d].layerInfo.featureLayer.id));c&&c.layerObject.isEditable()&&b.push({label:c.title,
value:c.id})}this.targetLayerSelector.set("options",b);0<b.length&&this.targetLayerSelector.set("value",b[0].value)},onShown:function(){this._initDependencies();this._validateStatus();this.pageContainer.backDisabled=0<this.pageContainer._backLabels.length?!1:!0},setStyleColor:function(a){this.styleColor=a},updateImageNodes:function(){if(this.pageContainer){var a=this.pageContainer.isDarkTheme,b=a?"next-arrow-img":"next-arrow-img-white",d=a?"next-arrow-img-white":"next-arrow-img";a=D("."+b,this.domNode);
p.forEach(a,function(c){g.remove(c,b);g.add(c,d)})}},validate:function(a,b){var d=new w;"next-view"===a?d.resolve(this._nextView(b)):"back-view"===a?d.resolve(this._backView()):"home-view"===a&&this._homeView(b).then(function(c){d.resolve(c)});return d},_nextView:function(a){a.navView.label===this.label&&this.pageContainer.toggleController(!1);if(this.parent._locationMappingComplete&&this.parent._fieldMappingComplete)return this.nextDisabled=!0,!1;this.pageContainer.backDisabled=!1;return!0},_backView:function(){return 0<
this.pageContainer._backLabels.length},_homeView:function(a){var b=new w;this.pageContainer.getViewByTitle("Home").verifyClearSettings(a).then(function(d){b.resolve(d)});return b},_locationMappingClick:function(a){if("keydown"!==a.type||a.keyCode===n.ENTER||a.keyCode===n.SPACE)this._validateStatus(),this._setViewByTitle(this.xyEnabled&&(this.multiEnabled||this.singleEnabled)?"LocationType":this.xyEnabled?"Coordinates":"Addresses")},_schemaMappingClick:function(a){if("keydown"!==a.type||a.keyCode===
n.ENTER||a.keyCode===n.SPACE)this._validateStatus(),this._setViewByTitle("FieldMapping")},_setViewByTitle:function(a){a=this.pageContainer.getViewByTitle(a);this.pageContainer.selectView(a.index)},_initDependencies:function(){if(this.pageContainer&&!this._coordinatesView&&!this._addressView&&!this._fieldMappingView){this.xyEnabled&&(this._coordinatesView=this.pageContainer.getViewByTitle("Coordinates"),this.own(r(this._coordinatesView,"location-mapping-update",f.hitch(this,function(a){this.parent._locationMappingComplete=
a;this._validateStatus()}))));if(this.singleEnabled||this.multiEnabled)this._addressView=this.pageContainer.getViewByTitle("Addresses"),this.own(r(this._addressView,"location-mapping-update",f.hitch(this,function(a){this.parent._locationMappingComplete=a;this._validateStatus()})));this._fieldMappingView=this.pageContainer.getViewByTitle("FieldMapping");this.own(r(this._fieldMappingView,"field-mapping-update",f.hitch(this,function(a){this.parent._fieldMappingComplete=a;this._validateStatus()})));(this._locationTypeView=
this.xyEnabled&&(this.singleEnabled||this.multiEnabled)?this.pageContainer.getViewByTitle("LocationType"):this.xyEnabled?this._coordinatesView:this._addressView)&&!this.parent._locationMappingComplete&&(this.altNextIndex=this._locationTypeView.index)}},_updateDoneStatus:function(a,b){b?(g.remove(a,"jimu-icon jimu-icon-error incomplete-mark"),g.add(a,"done-mark")):(g.add(a,"jimu-icon jimu-icon-error incomplete-mark"),g.remove(a,"done-mark"))},_validateStatus:function(){this._updateDoneStatus(this.locationMappingComplete,
this.parent._locationMappingComplete);this._updateDoneStatus(this.fieldMappingComplete,this.parent._fieldMappingComplete);var a=this.pageContainer.backDisabled=!1;this.parent._locationMappingComplete&&this.parent._fieldMappingComplete&&"mapping"===this.state?(a=!0,this.pageContainer.nextDisabled=!0):!this.parent._locationMappingComplete&&this._locationTypeView?this.altNextIndex=this._locationTypeView.index:!this.parent._fieldMappingComplete&&this._fieldMappingView&&(this.altNextIndex=this._fieldMappingView.index);
a||(this.pageContainer.nextDisabled=!1);this._updateNode(this.addToMapButton,a);this.lastFocusNode=a?this.addToMapButton:this.fieldMappingRow},_updateNode:function(a,b){b?g.contains(a,"display-none")&&g.remove(a,"display-none"):g.contains(a,"display-none")||g.add(a,"display-none")},_addToMapClick:function(a){if("keydown"!==a.type||a.keyCode===n.ENTER||a.keyCode===n.SPACE){this._updateNode(this.addToMapButton,!1);this._updateNode(this.progressNode,!0);a=this._fieldMappingView._getResults();var b=this._locationTypeView._getResults();
this._syncFields=this._checkFields(a.results,b);this._locateFeatures(a,b)}},_checkFields:function(a,b){var d={};b&&b.fields&&p.forEach(b.fields,function(c){var q=c.value?c.value:c.sourceField;c=c.keyField?c.keyField:c.sourceField;if("undefined"!==typeof q&&"undefined"!==typeof c&&!d.hasOwnProperty(q)&&a)for(var h=Object.keys(a),k=0;k<h.length;k++)if(a[h[k]]===q){d[c]={layerFieldName:h[k]};break}});return d},_locateFeatures:function(a,b){this.csvStore.useMultiFields="multi"===b.type?!0:!1;this.csvStore.mappedArrayFields=
a.results;this.csvStore.labelField=a.labelField;if("single"===b.type)this.csvStore.addrFieldName=b.fields[0].keyField,this.csvStore.singleFields=b.fields;else if("multi"===b.type)this.csvStore.multiFields=b.fields;else if("xy"===b.type){this.csvStore.useAddr=!1;var d=b.fields[0];b=b.fields[1];this.csvStore.xFieldName="X"===d.targetField?d.sourceField:b.sourceField;this.csvStore.yFieldName="Y"===b.targetField?b.sourceField:d.sourceField}this.csvStore.processForm().then(f.hitch(this,function(c){this._addResultView({matchedFeatures:this._formatFeatures(c.matchedLayer,
a.labelField),matchedLayer:c.matchedLayer,unMatchedFeatures:this._formatFeatures(c.unMatchedLayer,a.labelField),unMatchedLayer:c.unMatchedLayer,duplicateFeatures:this._formatFeatures(c.duplicateLayer,a.labelField,c.duplicateLookupList),duplicateLayer:c.duplicateLayer});this.state="review";this._reviewView=this.pageContainer.getViewByTitle("Review");this.pageContainer.nextDisabled=!1;this.pageContainer.backDisabled=!0;this.pageContainer._backLabels=[];this.pageContainer.altHomeIndex=this._reviewView.index;
this._updateNode(this.progressNode,!1);this.pageContainer.selectView(this._reviewView.index,!0);this.pageContainer._backLabels=[]}),f.hitch(this,function(c){console.log(c);this._updateNode(this.progressNode,!1);this._updateNode(this.addToMapButton,!0)}))},_formatFeatures:function(a,b,d){var c=[];if(a){var q=a.objectIdField;this._currentFields=a.fields;p.forEach(a.graphics,f.hitch(this,function(h){var k=[],u;d&&(u=d[h.attributes[q]]);p.forEach(Object.keys(h.attributes),f.hitch(this,function(l){var e=
this._currentFields.filter(function(H){return H.name===l}),m=h.attributes[l],v=!1;"."!==this.csvStore.decimalSeperator&&(v=e&&e.hasOwnProperty("length")&&1===e.length&&e[0].hasOwnProperty("type")&&"esriFieldTypeDouble"===e[0].type)&&(m=-1===[null,void 0,""].indexOf(m)?m.toString().replace(this.csvStore.decimalSeperator,"."):m);e={name:l,label:e&&e.hasOwnProperty("length")&&1===e.length&&e[0].alias?e[0].alias:l,formattedValue:v&&-1===[null,void 0].indexOf(m)?G.localizeNumber(m):m,value:m,needsFormat:v};
u&&(e.duplicateFieldInfo={value:u[l]});k.push(e)}));var t=k.filter(function(l){return l.name===b&&l.needsFormat});c.push({label:t&&t.hasOwnProperty("length")&&1===t.length?t[0].formattedValue:h.attributes[b],fieldInfo:k,geometry:h.geometry,address:""})}))}return c},_addResultView:function(a){var b=new E({nls:this.nls,map:this.map,parent:this.parent,config:this.config,appConfig:this.appConfig,matchedList:a.matchedFeatures,unMatchedList:a.unMatchedFeatures,duplicateList:a.duplicateFeatures,theme:this.theme,
csvStore:this.csvStore,editLayer:this.parent.editLayer,matchedLayer:a.matchedLayer,unMatchedLayer:a.unMatchedLayer,duplicateLayer:a.duplicateLayer,duplicateLookupList:a.duplicateLookupList,_syncFields:this._syncFields});this.pageContainer.addView(b);this._zoomToAllFeatures([a.matchedLayer,a.unMatchedLayer,a.duplicateLayer])},_zoomToAllFeatures:function(a){var b=[];p.forEach(a,function(d){if(d&&d.graphics)for(var c=0;c<d.graphics.length;c++)b.push(d.graphics[c])});this.csvStore._zoomToData(b)}})});