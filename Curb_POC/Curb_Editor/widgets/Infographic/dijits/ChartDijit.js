// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
require({cache:{"url:widgets/Infographic/dijits/ChartDijit.html":'\x3cdiv style\x3d"width:100%;height:100%;"\x3e\r\n    \x3cdiv style\x3d"display: none;" data-dojo-attach-point\x3d"yAxisName" class\x3d"y-axis-name rotate"\x3e\x3c/div\x3e\r\n    \x3cdiv class\x3d"chart-dijit" style\x3d"width:100%;height:100%;"\x3e\r\n        \x3cdiv data-dojo-attach-point\x3d"noDataDiv" class\x3d"no-data-tip"\x3e${nls.noData}\x3c/div\x3e\r\n        \x3cdiv data-dojo-attach-point\x3d"overlap" class\x3d"over-lay hide"\x3e\x3c/div\x3e\r\n        \x3cdiv class\x3d"chart-dom" data-dojo-attach-point\x3d"chartDomNode"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n\x3c/div\x3e'}});
define("dojo/_base/lang dojo/_base/html dojo/_base/declare ./BaseDijit dojo/text!./ChartDijit.html moment/moment jimu/dijit/_chartDijitOption jimu/dijit/Chart jimu/DataSourceManager jimu/LayerInfos/LayerInfos ../utils jimu/utils libs/moment/twix".split(" "),function(g,d,m,n,p,k,q,r,t,u,e,l){window.makeTwix(k);return m([n],{templateString:p,type:"chart",baseClass:"infographic-chart-dijit",layerInfosObj:null,dataSourceManager:null,featuresCountForPreview:50,dataSource:null,config:null,map:null,maxTimeIntervals:1E4,
maxLabels:1E4,dsType:"",constructor:function(a){this.visible=a.visible;this.layerInfosObj=u.getInstanceSync();this.dataSourceManager=t.getInstance();this.config=a.config;this.popupInfo=this.layerObject=this.featureLayerForFrameWork=null},postCreate:function(){this.inherited(arguments);this._init();this.upgradeConfig()},setLayerInfo:function(a,b,f){this.layerObject=a;this.popupInfo=f;this.featureLayerForFrameWork=b;this._initChartDijitOption()},getDataURL:function(){if(this.chart)return this.chart.getDataURL()},
resize:function(){this.chart&&this.chart.resize()},setVisible:function(a){this.visible=a},destroy:function(){this.chart&&this.chart.destroy();this.chart=null;this.inherited(arguments)},clearChart:function(){this.chart&&this.chart.clear();this.showNodata()},setBackgroundColor:function(a){this.domNode.style.backgroundColor=a},_setyAxisName:function(){var a=this.config&&this.config.display;(a=a&&a.yAxis)&&a.show&&"undefined"!==typeof a.name?(this._showyAxisName(),this._setyAxisNameText(a.name),(a=a.nameTextStyle)&&
a.color&&this._setyAxisNameColor(a.color)):this._hideyAxisName()},_setyAxisNameText:function(a){this.yAxisName.innerHTML=l.stripHTML(a)},_setyAxisNameColor:function(a){d.setStyle(this.yAxisName,"color",a)},_hideyAxisName:function(){d.setStyle(this.yAxisName,"display","none")},_showyAxisName:function(){d.setStyle(this.yAxisName,"display","flex")},resetData:function(){this.dataSource=null;this.dsType="";this.data=null;this._hasStatisticsed=void 0;this.featureLayerForFrameWork=this.popupInfo=this.layerObject=
null;this.chartDijitOption.init(null,null,null,this.map)},setDataSource:function(a){this.inherited(arguments);this.dataSource=a;this._calcDataSourceType(this.dataSource)},onUpdateDataStart:function(){this._showOverlay()},onUpdateDataDone:function(){this._hideOverlay()},_calcDataSourceType:function(a){a.layerId?this.dsType="CLIENT_FEATURES":a.frameWorkDsId&&(a=(a=e.getDsTypeInfoMeta(a.frameWorkDsId,this.appConfig))&&a.dsMeta)&&("Features"===a.type?this.dsType="FRAMEWORK_FEATURES":"FeatureStatistics"===
a.type&&(this.dsType="FRAMEWORK_STATISTICS"))},setConfig:function(a){this.config=a;this.upgradeConfig()},upgradeConfig:function(){this.config=e.upgradeChartAxisFormatConfig(this.config,this.layerObject,this.popupInfo)},onDataSourceDataUpdate:function(a){a&&"undefined"!==typeof a.features&&(this.inSettingPage&&a.features.length>this.featuresCountForPreview&&(a.features=a.features.slice(0,this.featuresCountForPreview)),this.data=a,this._hasStatisticsed=!!a.hasStatisticsed)},startRendering:function(){this.specialChartConfig(this.config);
this._shouldRenderChart()&&((this.chart||this._createJimuChart(),this._updateBackgroundColor(),this._setyAxisName(),this._splitConfig(),this._createChartSeriesOption(),this.seriesOption)?this._checkIsTooManyLabels(this.seriesOption)||(this._createChartOption(),this.chart.updateConfig(this.chartOption),this.chart.resize()):this.showNodata())},_createChartOption:function(){var a=this._isSameFeatures(),b=e.isEqual(this.dataOption,this._oldDataOption)&&e.isEqual(this.displayOption,this._oldDisplayOption);
a&&b||(this.chartOption=null,this.seriesOption&&(this.chartOption=this.chartDijitOption.updateChartOptionDisplay(g.clone(this.seriesOption),this.displayOption,this.dataOption),this._oldDisplayOption=null,this._oldDisplayOption=g.clone(this.displayOption)))},_createChartSeriesOption:function(){var a=this._isSameFeatures(),b=e.isEqual(this.dataOption,this._oldDataOption);a&&b||(this._oldDataOption=null,this._oldDataOption=g.clone(this.dataOption),a=this.dataOption,a.features=this.features,b=this.chartDijitOption.getClientStatisticsData(a),
this.seriesOption=null,b&&(this.chartDijitOption.bindChartEvent(this.chart,a,b),this.seriesOption=this.chartDijitOption.getChartOptionSeries(this.dataOption,b)))},_splitConfig:function(){if(this.config){var a=this.config.data,b=this.config.display;this.features=this._cleanFeatures(this.data.features);var f=this.dataSource.filterByExtent,c=this.dataSource.useSelection,h=this._isStatisticsed();f={filterByExtent:f,useSelection:c,hasStatisticsed:h};this.dataOption=null;this.dataOption=g.mixin(f,a);this.displayOption=
null;this.displayOption=b}},_cleanFeatures:function(a){if(a&&a.length)return a.map(function(b){return{attributes:b.attributes}})},_isSameFeatures:function(){var a=this.features;if(!a)return!0;a=a.map(function(b){return b.attributes});if(e.isEqual(a,this._oldFeatureAttrs))return!0;this._oldFeatureAttrs=a},_isStatisticsed:function(){return this.inSettingPage?"FRAMEWORK_STATISTICS"===this.dsType:!!this._hasStatisticsed},_shouldRenderChart:function(){if(this.visible&&this.config){var a=this.domNode&&
this.data&&this.data.features&&this._hasVaildConfig(this.config.data);if("CLIENT_FEATURES"===this.dsType)var b=!!this.layerObject;else if("FRAMEWORK_FEATURES"===this.dsType||"FRAMEWORK_STATISTICS"===this.dsType)b=!!this.featureLayerForFrameWork;if(a&&b){if(this._checkIsTooManyTimeInterval(this.data.features))return this.showNodata(this.nls.parsingperiodTip),!1}else return this.showNodata(),!1;this.hideNodata();return!0}},_hasVaildConfig:function(a){if(!a||!a.mode)return!1;var b=a.valueFields;if("feature"===
a.mode)return a.clusterField&&b&&b.length;if("category"===a.mode)return a.clusterField&&a.operation&&b&&b.length;if("count"===a.mode)return a.clusterField;if("field"===a.mode)return a.operation&&b&&b.length},_getNodataTextColor:function(){var a=this.config&&this.config.display;var b=this.config&&this.config.data;if(!a||!b)return"#666";(a="pie"===b.type?a.dataLabelColor:a.horizontalAxisTextColor||a.verticalAxisTextColor)||(a="#666");return a},specialChartConfig:function(a){if(a){var b=this._getChartTheme();
e.specialChartConfig(a,b);return a}},_showOverlay:function(){d.removeClass(this.overlap,"hide")},_hideOverlay:function(){d.addClass(this.overlap,"hide")},showNodata:function(a){d.addClass(this.domNode,"no-data");this._setNoDataColor();a&&(this.noDataDiv.innerHTML=l.sanitizeHTML(a))},_setNoDataColor:function(){var a=this._getNodataTextColor();this.noDataDiv&&this.noDataDiv.style&&(this.noDataDiv.style.color=a)},_initChartDijitOption:function(){if(this.chartDijitOption){var a=null;a="CLIENT_FEATURES"===
this.dsType?this.layerObject:this.featureLayerForFrameWork;this.chartDijitOption.init(a,this.layerObject,this.popupInfo,this.map,this.layerObject)}},_checkIsTooManyLabels:function(a){return(a=a.labels)&&a.length>this.maxLabels?(this.showNodata(this.nls.manyCategoryTip),!0):!1},_checkIsTooManyTimeInterval:function(a){var b=this.config&&this.config.data;b=b&&b.dateConfig;if(!b||"automatic"===b.minPeriod)return!1;var f=b.clusterField,c=a.map(g.hitch(this,function(h){return h.attributes[f]}));c=c.filter(function(h){return!!h});
a=Math.min.apply(Math,c);c=Math.max.apply(Math,c);a=k(a).subtract(1,"seconds").local();c=k(c).add(1,"seconds").local();return Math.round(c.diff(a,b.minPeriod,!0))>=this.maxTimeIntervals},_createChartDijitOption:function(){var a={map:null};this.inSettingPage||(a.map=this.map);this.chartDijitOption=new q(a)},_init:function(){this._createChartDijitOption();this._updateBackgroundColor()},_createJimuChart:function(){var a=this.config&&this.config.data;this.DEFAULT_CONFIG={type:a&&a.type||"column",theme:this._getChartTheme(),
labels:[],series:[{data:[]}]};this.chart=new r({chartDom:this.chartDomNode,config:this.DEFAULT_CONFIG,preview:this.inSettingPage});this.chart.placeAt(this.chartDomNode);this.chart.resize()},_getChartTheme:function(){return this.isDarkTheme()?"dark":"light"},_updateBackgroundColor:function(){var a=this.config&&this.config.display;a&&a.backgroundColor&&this.setBackgroundColor(a.backgroundColor)},hideNodata:function(){d.removeClass(this.domNode,"no-data")}})});