// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/lang dojo/_base/array dojo/string dojo/Deferred esri/lang esri/request dojo/_base/url esri/layers/TileInfo jimu/portalUtils esri/layers/ArcGISTiledMapServiceLayer esri/layers/ArcGISDynamicMapServiceLayer esri/layers/ArcGISImageServiceLayer esri/virtualearth/VETiledLayer esri/layers/OpenStreetMapLayer esri/layers/ImageParameters".split(" "),function(q,r,t,n,l,u,v,w,x,y,z,A,m,B,C){var c={TYPE:{BASE_MAP:"baseMap",ARCGIS_TILED_MAP:"tiledMapService",ARCGIS_DYNAMIC_MAP_SERVICE:"dynamicMapService",
ARCGIS_IMAGE_SERVICE:"imageService",OSM:"openStreetMap",BING_ROAD:"bingMapsRoad",BING_AERIAL:"bingMapsAerial",BING_HYBRID:"bingMapsHybrid"},createBaseLayer:function(a,b,d){var e=new n,f=null,k=a.url,h=a.type;a=a.veLayerInfo;h===c.TYPE.BASE_MAP?e.resolve({layer:"BaseMap"}):h===c.TYPE.ARCGIS_TILED_MAP?c.valid.isArcGISLayersValid(k,b,h).then(function(g){g&&!0===g.res?(f=new y(k),e.resolve({layer:f})):e.resolve({layer:null,err:g.err})},function(g){e.resolve({res:!1,err:g})}):h===c.TYPE.ARCGIS_DYNAMIC_MAP_SERVICE?
c.valid.isArcGISLayersValid(k,b,h).then(function(g){if(g&&!0===g.res){g=g.info;var p={};g&&g.supportedImageFormatTypes&&-1!==g.supportedImageFormatTypes.indexOf("PNG24")&&(p.imageParameters=new C,p.imageParameters.format="png24");f=new z(k,p);e.resolve({layer:f})}else e.resolve({layer:null,err:g.err})},function(g){e.resolve({res:!1,err:g})}):h===c.TYPE.ARCGIS_IMAGE_SERVICE?c.valid.isArcGISLayersValid(k,b,h).then(function(g){g&&!0===g.res?(f=new A(k,{}),e.resolve({layer:f})):e.resolve({layer:null,
err:g.err})},function(g){e.resolve({res:!1,err:g})}):h===c.TYPE.OSM?(f=new B(k,{}),e.resolve({layer:f})):h!==c.TYPE.BING_ROAD&&h!==c.TYPE.BING_AERIAL&&h!==c.TYPE.BING_HYBRID||!a?e.resolve({layer:null}):(b=c.layers.getBingMapKey(d),b&&a.isKeyInPortal||(b="__invalidKey",console.error("OverviewMap Error: BingMapsKey must be provided")),f=new m({bingMapsKey:b,mapStyle:c.layers._getVEStyle(h)}),e.resolve({layer:f}));return e},layers:{_getLayerInfoSR:function(a){return a.spatialReference||a.extent&&a.extent.spatialReference},
_getTileServers:function(a){var b=[],d=new v(a.url);if(a.subDomains&&0<a.subDomains.length&&1<d.authority.split(".").length){var e;r.forEach(a.subDomains,function(f){-1<d.authority.indexOf("${subDomain}")?e=d.scheme+"://"+t.substitute(d.authority,{subDomain:f})+"/":-1<d.authority.indexOf("{subDomain}")&&(e=d.scheme+"://"+d.authority.replace(/\{subDomain\}/gi,f)+"/");b.push(e)},this)}return b&&0<b.length?b:null},_getVEStyle:function(a){switch(a){case c.TYPE.BING_AERIAL:return m.MAP_STYLE_AERIAL;case c.TYPE.BING_HYBRID:return m.MAP_STYLE_AERIAL_WITH_LABELS;
case c.TYPE.BING_ROAD:return m.MAP_STYLE_ROAD;default:return m.MAP_STYLE_AERIAL}},fetchLayerInfo:function(a){var b=new n;u({url:a,handleAs:"json",callbackParamName:"callback",timeout:15E3,content:{f:"json"}}).then(q.hitch(this,function(d){b.resolve(d)}),function(d){b.reject(d)});return b},getBingMapKey:function(a){return(a=window.portalSelf||a&&x.getPortal(a.appConfig.portalUrl))&&a.bingKey?a.bingKey:""}},valid:{baseLayerVerification:function(a,b){var d=new n,e=b.spatialReference;c.createBaseLayer(a,
b).then(function(f){if(f.layer){var k=c.layers._getLayerInfoSR(f.layer);c.valid.sameSpatialReference(e,k)||"BaseMap"===f.layer?d.resolve({res:!0}):d.resolve({res:!1})}else d.resolve({res:!1,err:f.err})},function(f){d.resolve({res:!1,err:f})});return d},ArcGISLayersTypeVerification:function(a,b,d){a=a.toLowerCase();if(0<a.indexOf("/featureserver")||0<a.indexOf("/mapserver"))if(!b||"string"!==typeof b.type||"Feature Layer"!==b.type&&"Table"!==b.type){if(0<a.indexOf("/featureserver"))return!1;if(0<a.indexOf("/mapserver"))return b.tileInfo?
d===c.TYPE.ARCGIS_TILED_MAP||d===c.TYPE.ARCGIS_DYNAMIC_MAP_SERVICE?!0:!1:d===c.TYPE.ARCGIS_DYNAMIC_MAP_SERVICE?!0:!1}else return!1;else if(0<a.indexOf("/imageserver"))return d===c.TYPE.ARCGIS_IMAGE_SERVICE?!0:!1},isArcGISLayersValid:function(a,b,d){var e=new n;c.layers.fetchLayerInfo(a).then(function(f){var k=null,h=null;k=c.layers._getLayerInfoSR(f);h=b&&b.spatialReference;k&&h&&c.valid.sameSpatialReference(h,k)?!0===c.valid.ArcGISLayersTypeVerification(a,f,d)?e.resolve({res:!0,info:f}):e.resolve({res:!1,
err:"layerType"}):k&&h&&!c.valid.sameSpatialReference(h,k)?e.resolve({res:!1,err:"wkid"}):e.resolve({res:!1})},function(f){e.resolve({res:!1,err:f})});return e},tileInfoStr:function(a){try{return new w(JSON.parse(a)),!0}catch(b){return b}},isHaveBingKey:function(){return c.layers.getBingMapKey()?!0:!1},sameSpatialReference:function(a,b){var d=[102113,102100,3857,4326];return a&&b&&l.isDefined(a.wkid)&&l.isDefined(b.wkid)&&-1!==d.indexOf(a.wkid)&&-1!==d.indexOf(b.wkid)||a&&b&&(l.isDefined(a.wkid)&&
l.isDefined(b.wkid)&&a.wkid===b.wkid||l.isDefined(a.latestWkid)&&l.isDefined(b.wkid)&&a.latestWkid===b.wkid||l.isDefined(a.wkid)&&l.isDefined(b.latestWkid)&&a.wkid===b.latestWkid||l.isDefined(a.latestWkid)&&l.isDefined(b.latestWkid)&&a.latestWkid===b.latestWkid)||a&&b&&l.isDefined(a.wkt)&&l.isDefined(b.wkt)&&a.wkt===b.wkt?!0:!1}}};return c});