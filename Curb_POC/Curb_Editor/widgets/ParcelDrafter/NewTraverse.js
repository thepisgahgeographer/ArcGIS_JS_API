// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
require({cache:{"url:widgets/ParcelDrafter/NewTraverse.html":'\x3cdiv\x3e\r\n    \x3c!-- Traverse grid container--\x3e\r\n    \x3cdiv class\x3d"esriCTNewTraverseContainer"\x3e\r\n        \x3c!-- Traverse grid title--\x3e\r\n        \x3cdiv class\x3d"esriCTNewTraverseLabelDiv"\x3e\r\n            \x3cdiv class\x3d"esriCTGridEmptyLabel"\x3e\r\n                \x26nbsp\r\n            \x3c/div\x3e\r\n            \x3cdiv class\x3d"esriCTGridLabels esriCTEllipsis esriCTGridBearingLabel" title\x3d"${nls.traverseSettings.bearingLabel}"\x3e\r\n                ${nls.traverseSettings.bearingLabel}\r\n            \x3c/div\x3e\r\n            \x3cdiv class\x3d"esriCTGridLabels esriCTEllipsis" title\x3d"${nls.traverseSettings.lengthLabel}"\x3e\r\n                ${nls.traverseSettings.lengthLabel}\r\n            \x3c/div\x3e\r\n            \x3cdiv class\x3d"esriCTGridLabels esriCTEllipsis" title\x3d"${nls.traverseSettings.radiusLabel}"\x3e\r\n                ${nls.traverseSettings.radiusLabel}\r\n            \x3c/div\x3e\r\n        \x3c/div\x3e\r\n        \x3c!-- Traverse grid items--\x3e\r\n        \x3cdiv data-dojo-attach-point\x3d"traverseGrid" class\x3d"esriCTTraverseGrid"\x3e\r\n        \x3c/div\x3e\r\n        \x3c!-- Traverse grid initial entry row--\x3e\r\n        \x3cdiv data-dojo-attach-point\x3d"traverseEntryNode" class\x3d"esriCTEntrtyNodeContent esriCTRow"\x3e\r\n            \x3cdiv data-dojo-attach-point\x3d"lineSymbolNode" class\x3d"esriCTSymbolContainer"\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv data-dojo-attach-point\x3d"bearingNode" class\x3d"esriCTBearingRow" data-dojo-type\x3d"dijit/form/ValidationTextBox" aria-label\x3d"${nls.traverseSettings.bearingLabel}"\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv data-dojo-attach-point\x3d"lengthNode" data-dojo-type\x3d"dijit/form/ValidationTextBox" aria-label\x3d"${nls.traverseSettings.lengthLabel}"\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv data-dojo-attach-point\x3d"radiusNode" data-dojo-type\x3d"dijit/form/ValidationTextBox" aria-label\x3d"${nls.traverseSettings.radiusLabel}"\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv class\x3d"esriCTAddRow"\x3e\r\n                \x3cdiv data-dojo-attach-point\x3d"addButton" class\x3d"esriCTAddIcon"\r\n                title\x3d"${nls.traverseSettings.addButtonTitle}" tabindex\x3d"0" role\x3d"button" aria-label\x3d"${nls.traverseSettings.addButtonTitle}"\x3e\r\n                \x3c/div\x3e\r\n            \x3c/div\x3e\r\n        \x3c/div\x3e\r\n        \x3c!-- Traverse grid tools container--\x3e\r\n        \x3cdiv class\x3d"esriCTTraverseTool"\x3e\r\n            \x3cdiv class\x3d"esriCTTraverseToolContainer"\x3e\r\n                \x3c!-- Update rotation point tool--\x3e\r\n                \x3cdiv class\x3d"esriCTTraverseToolIcons ecriCTUpdateRotationPointIcon esriCTCursorPointer" title\x3d"${nls.planSettings.updateRotationPointTooltipText}"\r\n                    data-dojo-attach-point\x3d"updateRotationPointNode" tabindex\x3d"0" role\x3d"button" aria-label\x3d"${nls.planSettings.updateRotationPointTooltipText}" aria-pressed\x3d"false"\x3e\r\n                \x3c/div\x3e\r\n                \x3c!-- Screen digitization tool--\x3e\r\n                \x3cdiv class\x3d"esriCTTraverseToolIcons ecriCTLocationIcon esriCTCursorPointer" title\x3d"${nls.planSettings.onScreenDigitizationTooltipText}"\r\n                    data-dojo-attach-point\x3d"screenDigitizationNode" tabindex\x3d"0" role\x3d"button" aria-label\x3d"${nls.planSettings.onScreenDigitizationTooltipText}" aria-pressed\x3d"false"\x3e\r\n                \x3c/div\x3e\r\n                \x3c!-- Zoom tool--\x3e\r\n                \x3cdiv class\x3d"esriCTHidden esriCTTraverseToolIcons ecriCTZoomToIcon esriCTCursorPointer" title\x3d"${nls.planSettings.zoomToLocationTooltipText}"\r\n                    data-dojo-attach-point\x3d"zoomToNode" tabindex\x3d"0" role\x3d"button" aria-label\x3d"${nls.planSettings.zoomToLocationTooltipText}"\x3e\r\n                \x3c/div\x3e\r\n                \x3c!-- Expand/Collapse grid tool--\x3e\r\n                \x3cdiv class\x3d"esriCTHidden  esriCTTraverseToolIcons esriCTCollapse esriCTCursorPointer" title\x3d"${nls.planSettings.collapseGridTooltipText}"\r\n                    data-dojo-attach-point\x3d"expandCollapseNode" tabindex\x3d"0" role\x3d"button" aria-label\x3d"${nls.planSettings.collapseGridTooltipText}"\x3e\r\n                \x3c/div\x3e\r\n            \x3c/div\x3e\r\n        \x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3c!-- Misclose details container--\x3e\r\n    \x3cdiv data-dojo-attach-point\x3d"misCloseDetailsNode"\x3e\r\n    \x3c/div\x3e\r\n    \x3c!-- Parcel tools (rotation/scale) container--\x3e\r\n    \x3cdiv data-dojo-attach-point\x3d"parcelToolsNode"\x3e\r\n    \x3c/div\x3e\r\n    \x3c!-- Parcel info (polygon layer fields) \x26 save/cancle button container--\x3e\r\n    \x3cdiv class\x3d"esriCTPlanInfoNode" data-dojo-attach-point\x3d"planInfoNode"\x3e\r\n    \x3c/div\x3e\r\n\x3c/div\x3e'}});
define("dojo/_base/declare jimu/BaseWidget dijit/_WidgetsInTemplateMixin dojo/Evented dojo/text!./NewTraverse.html dojo/_base/lang dojo/_base/array dojo/dom-class dojo/dom-construct dojo/dom-style dojo/dnd/Source dojo/on dijit/form/ValidationTextBox ./SymbolSelector ./MiscloseDetails ./ParcelTools ./PlanInfo ./geometryUtils ./utils esri/graphic esri/symbols/jsonUtils esri/layers/GraphicsLayer esri/graphicsUtils dojo/dom-attr dojo/query esri/SpatialReference dojo/keys dijit/focus dijit/TooltipDialog dijit/popup dojo/Deferred esri/geometry/Extent esri/geometry/Point dojo/dom-geometry".split(" "),
function(G,H,I,J,K,g,w,m,r,E,L,q,M,N,O,P,Q,k,n,x,z,A,R,l,C,y,p,u,S,F,T,U,V,D){return G([H,I,J],{baseClass:"jimu-widget-ParcelDrafter",templateString:K,parcelLinesGraphicsLayer:null,parcelPointsGraphicsLayer:null,parcelPolygonGraphicsLayer:null,lineLayerSpatialReference:null,polygonLayerSpatialReference:null,_itemList:[],_nodes:[],_dndContainer:null,startPoint:null,_startPointForNextLine:null,_planSettings:null,_arrayOfAllBoundaryLines:[],_rotationAngle:0,_scaleValue:1,polygonDeleteArr:[],polylineDeleteArr:[],
_popupDialog:null,_popupCoords:null,_setExtentTimer:null,numberFieldTypes:["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"],lengthFieldPlaces:2,radiusFieldPlaces:2,miscloseDistanceFieldPlaces:2,postCreate:function(){this.numberFieldTypes=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"];this.polygonDeleteArr=[];this.polylineDeleteArr=[];this._arrayOfAllBoundaryLines=[];this._nodes=[];this._itemList=[];this._setExtentTimer=
null;m.add(this.domNode,"esriCTNewTraverseGrid");this._addGraphicsLayer();this._createTraverseGrid();this._setValidatorForInitialRow();this._handleEventsOnInitialRow();this._symbolSelector=this._createLineSelector(this.lineSymbolNode,null);this.own(q(this.screenDigitizationNode,"click",g.hitch(this,this._onDigitizationButtonClicked)));this.own(q(this.screenDigitizationNode,"keydown",g.hitch(this,function(a){if(a.keyCode===p.ENTER||a.keyCode===p.SPACE)a.preventDefault(),this._onDigitizationButtonClicked()})));
this.own(q(this.updateRotationPointNode,"click",g.hitch(this,this._onUpdateRotationPointButtonClicked)));this.own(q(this.updateRotationPointNode,"keydown",g.hitch(this,function(a){if(a.keyCode===p.ENTER||a.keyCode===p.SPACE)a.preventDefault(),this._onUpdateRotationPointButtonClicked()})));this.own(q(this.zoomToNode,"click",g.hitch(this,this._onZoomButtonClicked)));this.own(q(this.zoomToNode,"keydown",g.hitch(this,function(a){if(a.keyCode===p.ENTER||a.keyCode===p.SPACE)a.preventDefault(),this._onZoomButtonClicked()})));
this.own(q(this.expandCollapseNode,"click",g.hitch(this,this._onExpandCollapseClicked)));this.own(q(this.expandCollapseNode,"keydown",g.hitch(this,function(a){if(a.keyCode===p.ENTER||a.keyCode===p.SPACE)a.preventDefault(),this._onExpandCollapseClicked()})));this.own(q(this.addButton,"click",g.hitch(this,function(){this._addNewItem(!1)})));this.own(q(this.addButton,"keydown",g.hitch(this,function(a){a.keyCode!==p.ENTER&&a.keyCode!==p.SPACE||this._addNewItem(!1)})));this._createMiscloseDetails();this._createParcelTools();
this._createPlanInfo();this._createTooltip();this.config.polylineLayer&&this.config.polylineLayer.popupInfo&&this.config.polylineLayer.popupInfo.fieldInfos&&w.forEach(this.config.polylineLayer.popupInfo.fieldInfos,g.hitch(this,function(a){a.fieldName===this.config.polylineLayer.bearing.name&&a.format&&(n.bearingFieldPlaces=a.format.places);a.fieldName===this.config.polylineLayer.distance.name&&a.format&&(this.lengthFieldPlaces=a.format.places);a.fieldName===this.config.polylineLayer.radius.name&&
a.format&&(this.radiusFieldPlaces=a.format.places)}));this.config.polygonLayer&&this.config.polygonLayer.popupInfo&&this.config.polygonLayer.popupInfo.fieldInfos&&w.forEach(this.config.polygonLayer.popupInfo.fieldInfos,g.hitch(this,function(a){a.fieldName===this.config.polygonLayer.miscloseDistance.name&&a.format&&(this.miscloseDistanceFieldPlaces=a.format.places)}))},_addGraphicsLayer:function(){this.parcelPolygonGraphicsLayer=new A;this.parcelLinesGraphicsLayer=new A;this.parcelPointsGraphicsLayer=
new A;this.rotationPointsGraphicsLayer=new A;this.own(q(this.parcelPointsGraphicsLayer,"click",g.hitch(this,function(a){m.contains(this.updateRotationPointNode,"esriCTEnableButton")&&(this._setRotationPoint(a.graphic.attributes.rowIndex,a.graphic.geometry),this._showRotationPoint())})));this.map.addLayer(this.parcelPolygonGraphicsLayer);this.map.addLayer(this.parcelLinesGraphicsLayer);this.map.addLayer(this.parcelPointsGraphicsLayer);this.map.addLayer(this.rotationPointsGraphicsLayer)},_setValidatorForInitialRow:function(){this.bearingNode.validator=
g.hitch(this,function(a){return this._bearingValidator(a,["*","*tb"])});this.bearingNode.invalidMessage=this.nls.newTraverse.invalidBearingMessage;this.lengthNode.validator=g.hitch(this,function(a){if("*"===a&&this._itemList&&0<this._itemList.length)return!0;if(""===this.radiusNode.get("value")&&0>parseFloat(a))return this.lengthNode.invalidMessage=this.nls.newTraverse.negativeLengthMessage,!1;this.lengthNode.invalidMessage=this.nls.newTraverse.invalidLengthMessage;return this._lengthValidator(a)});
this.lengthNode.invalidMessage=this.nls.newTraverse.invalidLengthMessage;this.radiusNode.validator=g.hitch(this,function(a){if("*"===a&&this._itemList&&0<this._itemList.length)return!0;var b=this._radiusValidator(a);if(""!==a)if((a=this.lengthNode.isValid())&&b){if(!this._validateLengthRadiusProportion(b,a))return null;b&&(a=this.lengthNode.value,this.lengthNode.reset(),this.lengthNode.set("value",a))}else b=null;return b});this.radiusNode.invalidMessage=this.nls.newTraverse.invalidRadiusMessage},
_bearingValidator:function(a,b){return-1!==b.indexOf(a)&&this._itemList&&0<this._itemList.length?!0:this._validateBearing(a,b)},_lengthValidator:function(a,b){return""===a||"0"===a||0===a?!1:this._validateLength(a,b)},_radiusValidator:function(a,b){return""===a?!0:this._validateLength(a,b)},_handleEventsOnInitialRow:function(){this.own(q(this.bearingNode,"keypress",g.hitch(this,this._bearingValueEntered)));this.own(q(this.lengthNode,"keypress",g.hitch(this,this._lengthValueEntered)));this.own(q(this.radiusNode,
"keypress",g.hitch(this,this._radiusValueEntered)))},_copyPrevValue:function(a){switch(a){case "Bearing":a=this.bearingNode.get("value");"*"===a&&0<this._itemList.length&&(a=this._itemList[this._itemList.length-1].BearingConversions?this._getBearingAccordingToPlanSettings(this._itemList[this._itemList.length-1].BearingConversions):this._itemList[this._itemList.length-1].Bearing,this.bearingNode.set("value",a));break;case "Length":a=this.lengthNode.get("value");"*"===a&&0<this._itemList.length&&(a=
"radiusAndArcLength"===this._planSettings.circularCurveParameters&&this._itemList[this._itemList.length-1].ArcLengthConversions?this._itemList[this._itemList.length-1].ArcLengthConversions[this._planSettings.distanceAndLengthUnits]:this._itemList[this._itemList.length-1].LengthConversions?this._itemList[this._itemList.length-1].LengthConversions[this._planSettings.distanceAndLengthUnits]:this._itemList[this._itemList.length-1].Length,this.lengthNode.set("value",a));break;case "Radius":a=this.radiusNode.get("value"),
"*"===a&&0<this._itemList.length&&(a=this._itemList[this._itemList.length-1].RadiusConversions?this._itemList[this._itemList.length-1].RadiusConversions[this._planSettings.distanceAndLengthUnits]:this._itemList[this._itemList.length-1].Radius,this.radiusNode.set("value",a))}},_bearingValueEntered:function(a){a=a.charCode||a.keyCode;a===p.ENTER||a===p.TAB?(this.bearingNode.get("value"),this._copyPrevValue("Bearing"),a===p.ENTER&&this.bearingNode.isValid()?u.focus(this.lengthNode.focusNode):this.bearingNode.validate(!1)):
setTimeout(g.hitch(this,function(){this.bearingNode.validate(!1)}),100)},_lengthValueEntered:function(a){a=a.charCode||a.keyCode;a===p.ENTER||a===p.TAB?(this.lengthNode.get("value"),this._copyPrevValue("Length"),a===p.ENTER&&this.lengthNode.isValid()?u.focus(this.radiusNode.focusNode):this.lengthNode.validate(!1)):setTimeout(g.hitch(this,function(){this.lengthNode.validate(!1)}),100)},_radiusValueEntered:function(a){(a.charCode||a.keyCode)===p.ENTER?(a=this.radiusNode.get("value"),this._copyPrevValue("Radius"),
""===a||this.radiusNode.isValid()?this.bearingNode.isValid()?this.lengthNode.isValid()?(this._addNewItem(),u.focus(this.bearingNode.focusNode)):(this.lengthNode.validate(!1),u.focus(this.lengthNode.focusNode)):(this.bearingNode.validate(!1),u.focus(this.bearingNode.focusNode)):this.radiusNode.validate(!1)):setTimeout(g.hitch(this,function(){this.radiusNode.validate(!1)}),100)},_validateBearing:function(a){return(a=n.categorizeBearingFormat(a,this._planSettings))?a:null},_validateLength:function(a,
b){switch(b){case "feet":a=n.categorizeLengthFormat(a,"feet");break;case "meters":a=n.categorizeLengthFormat(a,"meters");break;case "uSSurveyFeet":a=n.categorizeLengthFormat(a,"uSSurveyFeet");break;default:a=n.categorizeLengthFormat(a,this._planSettings.distanceAndLengthUnits)}return a?a:null},_validateLengthRadiusProportion:function(a,b){return a&&b&&(a=a[this._planSettings.distanceAndLengthUnits],b=b[this._planSettings.distanceAndLengthUnits],0!==a&&(a=2*parseFloat(Math.abs(a)),"radiusAndArcLength"===
this._planSettings.circularCurveParameters&&(a*=Math.PI),a<parseFloat(Math.abs(b))))?null:!0},_getValidatedValues:function(a,b,c){var d={},e;a?(d=a,b&&("Bearing"!==b&&d.BearingConversions&&(d.Bearing=this._getBearingAccordingToPlanSettings(d.BearingConversions)),"Length"!==b&&d.LengthConversions&&(d.Length=d.LengthConversions[this._planSettings.distanceAndLengthUnits]),"Radius"!==b&&d.RadiusConversions&&(d.Radius=d.RadiusConversions[this._planSettings.distanceAndLengthUnits]),"Bearing"===b&&"*tb"===
d.Bearing.toString().toLowerCase()&&0<this._itemList.length&&0!==c&&(d.isTB=!0))):(this._copyPrevValue("Bearing"),this._copyPrevValue("Length"),this._copyPrevValue("Radius"),d.LineSymbol=this._symbolSelector.selectedSymbol,d.Bearing=this.bearingNode.get("value"),d.Length=this.lengthNode.get("value"),d.Radius=this.radiusNode.get("value"),"*tb"===d.Bearing.toString().toLowerCase()&&0<this._itemList.length?d.isTB=!0:d.isTB=!1);if(""!==g.trim(d.Bearing.toString())&&""!==g.trim(d.Length.toString())&&((b=
this._validateBearing(d.Bearing))||d.isTB)){d.BearingConversions=b;if(""===g.trim(d.Length.toString())&&""===g.trim(d.Radius.toString()))return null;if(""!==g.trim(d.Length.toString()))if((b=this._validateLength(d.Length))&&0!==b.meters){if(""!==g.trim(d.Radius.toString()))if(e=this._validateLength(d.Radius)){if(!this._validateLengthRadiusProportion(e,b))return null;d.RadiusConversions=e}else return null;else{if(0>parseInt(b.meters,10))return null;d.RadiusConversions=null}d.LengthConversions=b}else return null;
d.RadiusConversions&&(d=this._createValuesForArc(d));d.isTB&&(a=a&&!isNaN(c)?this._itemList[c-1]:this._itemList[this._itemList.length-1],d=this._setTangentBearing(d,a))}else return null;return d},_setTangentBearing:function(a,b){var c=g.clone(this._planSettings);c.directionOrAngleType="northAzimuth";c.directionOrAngleUnits="decimalDegree";var d=b.BearingConversions.naDD;b.RadiusConversions&&0!==b.RadiusConversions.meters&&(d=k.chordBearingToTangentBearing(d,b.RadiusConversions.meters,b.ChordLengthConversions.meters));
a.RadiusConversions&&0!==a.RadiusConversions.meters?(d=k.tangentBearingToChordBearing(d,a.RadiusConversions.meters,a.ChordLengthConversions.meters),a.Bearing=d,a.BearingConversions=n.categorizeBearingFormat(a.Bearing,c)):b.RadiusConversions&&0!==b.RadiusConversions.meters?(a.Bearing=d,a.BearingConversions=n.categorizeBearingFormat(a.Bearing,c)):(a.Bearing=b.Bearing,a.BearingConversions=g.clone(b.BearingConversions));return a},_updateTBFromIndex:function(a){var b;for(b=!1;a<this._itemList.length;a++)if(this._itemList[a]&&
this._itemList[a].isTB)this._itemList[a]=this._setTangentBearing(this._itemList[a],this._itemList[a-1]),b=!0;else break;return b},_onZoomButtonClicked:function(){this._setExtentToLayer(this.parcelLinesGraphicsLayer,!0)},_onExpandCollapseClicked:function(){m.toggle(this.traverseGrid,"esriCTHidden");m.contains(this.expandCollapseNode,"esriCTExpand")?(l.set(this.expandCollapseNode,"title",this.nls.planSettings.collapseGridTooltipText),m.replace(this.expandCollapseNode,"esriCTCollapse","esriCTExpand"),
l.set(this.expandCollapseNode,"aria-expanded",!0)):(l.set(this.expandCollapseNode,"title",this.nls.planSettings.expandGridTooltipText),m.replace(this.expandCollapseNode,"esriCTExpand","esriCTCollapse"),l.set(this.expandCollapseNode,"aria-expanded",!1))},setRotation:function(a){var b,c;var d=this.startPoint;this._rotationPointInfo&&this._rotationPointInfo.rotationPoint&&(d=this._rotationPointInfo.rotationPoint);var e=new y(4326);k.getProjectedGeometry(a,e,this.geometryService).then(g.hitch(this,function(f){b=
k.getRotationAngleBetweenPoints(d,f);0<this._itemList.length&&(c=0,this._rotationPointInfo&&this._rotationPointInfo.rotationPointIndex<this._itemList.length&&(c=this._rotationPointInfo.rotationPointIndex),b-=this._itemList[c].BearingConversions.naDDRound);360===b&&(b=0);this._parcelToolInstance.setRotation(b)}))},setScaling:function(a){a=k.getScaleDistanceBetweenPoints(this.startPoint,a);this.distance?(a/=this.distance,.1>a&&(a=.1),this._parcelToolInstance.setScale(a)):this.distance=a},_addNewItem:function(a){var b;
if(b=this._getValidatedValues()){if(a&&this._rotationAngle){var c=b.BearingConversions.naDD-this._rotationAngle;c=this.getAngleFromDDTOQB(360<=c?c%360:c);b.Bearing=c;b.BearingConversions=this._validateBearing(c)}c=g.trim(b.Radius.toString());b.rowIndex=this._itemList.length;this._itemList.push(b);this._createRow(b,this._itemList.length-1);u.focus(this.bearingNode.focusNode);this._resetEntryRow(a);""===c||"0"===c||0===c?this._drawStraightLine(b,!0):this._drawArc(b,!0);this._showHideTraverseTools();
this.appliedCompassRule&&this.setParcelClosure()}else this.bearingNode.isValid()?""!==this.lengthNode.get("value")&&this.lengthNode.isValid()?""===this.radiusNode.get("value")||this.radiusNode.isValid()||(u.focus(this.radiusNode.focusNode),this.radiusNode.validate(!1)):(u.focus(this.lengthNode.focusNode),this.lengthNode.validate(!1)):(u.focus(this.bearingNode.focusNode),this.bearingNode.validate(!1))},_createValuesForArc:function(a){if(a.RadiusConversions){var b=a.RadiusConversions.meters;"radiusAndArcLength"===
this._planSettings.circularCurveParameters?(a.ArcLength=a.LengthConversions.meters,a.ArcLengthConversions=g.clone(a.LengthConversions),a.ChordLength=k.getChordLengthFromArcLength(a.ArcLength,b),a.ChordLengthConversions=this._validateLength(a.ChordLength,"meters")):(a.ChordLength=a.LengthConversions.meters,a.ChordLengthConversions=g.clone(a.LengthConversions),a.ArcLength=k.getArcLengthFromChordLength(a.ChordLength,b),a.ArcLengthConversions=this._validateLength(a.ArcLength,"meters"))}else"radiusAndArcLength"===
this._planSettings.circularCurveParameters&&a.ArcLengthConversions&&(a.Length=a.ArcLength,a.LengthConversions=g.clone(a.ArcLengthConversions)),a.ChordLength=0,a.ChordLengthConversions=null,a.ArcLength=0,a.ArcLengthConversions=null;return a},_onDigitizationButtonClicked:function(){m.toggle(this.screenDigitizationNode,"esriCTEnableButton");m.contains(this.screenDigitizationNode,"esriCTEnableButton")?(l.set(this.screenDigitizationNode,"aria-pressed","true"),this.emit("activateDigitizationTool"),this.deActivateUpdateRotationPointTool()):
(l.set(this.screenDigitizationNode,"aria-pressed","false"),this.emit("deActivateDigitizationTool"))},_onUpdateRotationPointButtonClicked:function(){m.toggle(this.updateRotationPointNode,"esriCTEnableButton");m.contains(this.updateRotationPointNode,"esriCTEnableButton")?(l.set(this.updateRotationPointNode,"aria-pressed","true"),this.emit("activateUpdateRotationPointTool"),this.deActivateDigitizationTool()):(l.set(this.updateRotationPointNode,"aria-pressed","false"),this.emit("deActivateUpdateRotationPointTool"))},
_createMiscloseDetails:function(){this._misCloseDetailsInstance=new O({nls:this.nls,config:this.config,appConfig:this.appConfig,numberFieldTypes:this.numberFieldTypes,validateNumericField:this.validateNumericField},r.create("div",{},this.misCloseDetailsNode));this._misCloseDetailsInstance.setMiscloseDetails(null)},_createParcelTools:function(){this._parcelToolInstance=new P({nls:this.nls,config:this.config,canProjectLocally:k.canProjectLocally(this.map.spatialReference)},r.create("div",{},this.parcelToolsNode));
this.own(this._parcelToolInstance.on("rotateGeometries",g.hitch(this,function(a){a!==this._rotationAngle&&(this._rotationAngle=a,this._rotationPointInfo&&this._rotationPointInfo.rotationPoint?this._updateStartPointFromRotationPoint():this._itemList&&0<this._itemList.length&&this.setStartPoint(this.startPoint))})));this.own(this._parcelToolInstance.on("scaleGeometries",g.hitch(this,function(a){a!==this._scaleValue&&(this._scaleValue=a,this._rotationPointInfo&&this._rotationPointInfo.rotationPoint?
this._updateStartPointFromRotationPoint():this._itemList&&0<this._itemList.length&&this.setStartPoint(this.startPoint))})));this.own(this._parcelToolInstance.on("toggleRotating",g.hitch(this,function(a){this.emit("toggleRotating",a)})));this.own(this._parcelToolInstance.on("toggleScaling",g.hitch(this,function(a){this.emit("toggleScaling",a)})))},_createPlanInfo:function(){this._planInfoInstance=new Q({map:this.map,nls:this.nls,config:this.config,loading:this.loading,numberFieldTypes:this.numberFieldTypes,
validateNumericField:this.validateNumericField,geometryService:this.geometryService,parcelPolygonGraphicsLayer:this.parcelPolygonGraphicsLayer,parcelLinesGraphicsLayer:this.parcelLinesGraphicsLayer,polylineLayerUnit:k.getUnitValueForSR(this.lineLayerSpatialReference),polygonLayerUnit:k.getUnitValueForSR(this.polygonLayerSpatialReference),widgetDomNode:this.widgetDomNode},r.create("div",{},this.planInfoNode));this.own(this._planInfoInstance.on("cancelTraversedParcel",g.hitch(this,function(){this.emit("cancelTraverse")})));
this.own(this._planInfoInstance.on("showMessage",g.hitch(this,function(a){this._showMessage(a)})));this.own(this._planInfoInstance.on("showParcelSavedAndDeleteMsg",g.hitch(this,function(a){this._showParcelSavedAndDeleteMsg(a)})));this.own(this._planInfoInstance.on("saveTraversedParcel",g.hitch(this,function(){this.closePopup();if(this._itemList&&0<this._itemList.length){var a=this._misCloseDetailsInstance.traverseStatedArea.get("value").trim();var b=this._planInfoInstance.validateParcelDetails(a);
b.status?(""===this._misCloseDetailsInstance.traverseStatedArea.get("value")&&(a=null),b={},b.itemList=this._itemList,b.statedArea=a,b.rotation=this._rotationAngle,b.scale=this._scaleValue,b.appliedCompassRule=this.appliedCompassRule,b.miscloseDetails=this._misCloseDetailsInstance.getMiscloseDetails(),b.polygonDeleteArr=this.polygonDeleteArr,b.polylineDeleteArr=this.polylineDeleteArr,b.planSettings=this._planSettings,this._planInfoInstance.saveData(b)):b.message&&this._showMessage(b.message)}else this._showMessage(this.nls.newTraverse.enterValidParcelInfoMessage)})));
this.own(this._planInfoInstance.on("displayMainPageAfterSave",g.hitch(this,function(){this.emit("displayMainPageAfterSave",!1)})))},_createTraverseGrid:function(){var a;this._nodes=[];r.empty(this.traverseGrid);this._dndContainer=new L(this.traverseGrid,{skipForm:!0,singular:!0});this._dndContainer.copyState=function(){return!1};for(a=0;a<this._itemList.length;a++)this._createRow(this._itemList[a],a);this.own(this._dndContainer.on("DndDrop",g.hitch(this,this._onDndDrop)));this._dndContainer.insertNodes(!1,
this._nodes)},_createFieldInputs:function(a,b,c,d){var e=new M({value:b,"class":c?c:""});e.placeAt(a);"esriCTBearingRow"===c?(l.set(e,"aria-label",this.nls.traverseSettings.bearingLabel),e.validator=g.hitch(this,function(f){"*tb"!==f&&"*"===f.charAt(0)&&(f=f.slice(1));return this._bearingValidator(f,["*tb"])}),e.invalidMessage=this.nls.newTraverse.invalidBearingMessage):"esriCTLengthRow"===c?(l.set(e,"aria-label",this.nls.traverseSettings.lengthLabel),e.validator=g.hitch(this,this._lengthValidator),
e.invalidMessage=this.nls.newTraverse.invalidLengthMessage):"esriCTRadiusRow"===c&&(l.set(e,"aria-label",this.nls.traverseSettings.radiusLabel),e.validator=g.hitch(this,this._radiusValidator),e.invalidMessage=this.nls.newTraverse.invalidRadiusMessage);this.own(q(e,"blur",g.hitch(this,function(){var f=parseInt(l.get(a,"rowIndex"),10);this._updateParcelValues(e,f,d)})));this.own(q(e,"keypress",g.hitch(this,function(f){(f.charCode||f.keyCode)===p.ENTER&&(f=parseInt(l.get(a,"rowIndex"),10),this._updateParcelValues(e,
f,d));setTimeout(g.hitch(this,function(){e.validate(!1)}),100)})))},_createRow:function(a,b){var c=r.create("div",{"class":"dojoDndItem esriCTRow",rowIndex:b});var d=r.create("div",{rowIndex:b},c);this._createLineSelector(d,a.LineSymbol,b);d=this._getBearingAccordingToPlanSettings(a.BearingConversions);a.isTB&&(d="*"+d);this._createFieldInputs(c,d,"esriCTBearingRow");a.RadiusConversions?(d=this._getRoundedValue(a.RadiusConversions,"Radius"),a="radiusAndArcLength"===this._planSettings.circularCurveParameters?
this._getRoundedValue(a.ArcLengthConversions,"Length"):this._getRoundedValue(a.ChordLengthConversions,"Length")):(d="",a=this._getRoundedValue(a.LengthConversions,"Length"));this._createFieldInputs(c,a,"esriCTLengthRow");this._createFieldInputs(c,d,"esriCTRadiusRow");this._createDeleteButton(c,b);this._nodes.push(c);this._dndContainer.clearItems();this._dndContainer.insertNodes(!1,this._nodes)},_createLineSelector:function(a,b,c){var d=new N({hideOnSelect:!0,symbolData:this.config.lineTypes,tabindex:"0",
"aria-label":this.nls.newTraverse.lineTypeLabel,role:"button","aria-haspopup":"true"},a);m.add(d.domNode,"esriCTSymbolContainer");b?(d.selectSymbol(b),l.set(d.domNode,"rowIndex",c),d.onSelect=g.hitch(this,function(e){var f=parseInt(l.get(d.domNode,"rowIndex"),10);this._itemList[f].LineSymbol=e;this.setStartPoint(this.startPoint)})):d.setDefault();return d},_createDeleteButton:function(a,b){var c=r.create("div",{"class":"esriCTDeleteRow"},a);b=r.create("div",{"class":"esriCTDeleteIcon",rowIndex:b,
title:this.nls.traverseSettings.deleteButtonTitle,tabindex:"0",role:"button","aria-label":this.nls.traverseSettings.deleteButtonTitle},c);this.own(q(b,"click",g.hitch(this,function(d){d=parseInt(l.get(d.currentTarget,"rowIndex"),10);this._deleteRow(a,d)})));this.own(q(b,"keydown",g.hitch(this,function(d){if(d.keyCode===p.ENTER||d.keyCode===p.SPACE)d=parseInt(l.get(d.currentTarget,"rowIndex"),10),this._deleteRow(a,d),u.focus(this.bearingNode.focusNode)})))},_deleteRow:function(a,b){var c;if(this._itemList.length){this._dndContainer.delItem(a.id);
r.destroy(a);this._nodes.splice(b,1);this._itemList.splice(b,1);this._dndContainer.sync();this._updateRowIndexes();if(this._itemList[b]&&this._itemList[b].isTB){if(1===this._itemList.length||0===b)this._itemList[0].isTB=!1,b++;1<this._itemList.length&&(c=this._updateTBFromIndex(b))}this.appliedCompassRule?this.setParcelClosure(!0,!0):this.setStartPoint(this.startPoint,!0);c&&this._reGenerateTraverseGrid();this._showHideTraverseTools()}},_updateRowIndexes:function(){var a=C(".esriCTRow",this.traverseGrid);
w.forEach(a,g.hitch(this,function(b,c){var d;this._itemList[c].rowIndex=c;l.set(b,"rowIndex",c);(d=C(".esriCTDeleteIcon",b)[0])&&l.set(d,"rowIndex",c);(b=C(".esriCTSymbolContainer",b)[0])&&l.set(b,"rowIndex",c)}))},_onDndDrop:function(){var a=[];this._dndContainer.sync();var b=this._dndContainer.getAllNodes();b.forEach(g.hitch(this,function(d,e){d=parseInt(l.get(d,"rowIndex"),10);a.push(this._itemList[d])}));this._nodes=b;this._itemList=[];this._itemList=a;this._updateRowIndexes();for(b=0;b<this._itemList.length;b++){if(0===
b&&this._itemList[b].isTB){this._itemList[b].isTB=!1;var c=!0}this._itemList[b]&&this._itemList[b].isTB&&(this._itemList[b]=this._setTangentBearing(this._itemList[b],this._itemList[b-1]),c=!0)}this.setStartPoint(this.startPoint,!0);c&&this._reGenerateTraverseGrid()},_updateParcelValues:function(a,b,c){var d,e=!1;if(d=this._itemList[b]){var f=(f=a.get("value"))?g.trim(f.toString()):"";if(m.contains(a.domNode,"esriCTBearingRow")&&String(this._getBearingAccordingToPlanSettings(d.BearingConversions))!==
f){var h="Bearing";d.Bearing=f;e=!0;-1===f.indexOf("*")&&(d.isTB=!1)}else m.contains(a.domNode,"esriCTLengthRow")&&String(this._getRoundedValue(d.LengthConversions,"Length"))!==f?(h="Length",d.Length=f,e=!0):m.contains(a.domNode,"esriCTRadiusRow")&&String(d.Radius)!==f&&(d.RadiusConversions?String(this._getRoundedValue(d.RadiusConversions,"Radius"))!==f&&(h="Radius",d.Radius=f,e=!0):(h="Radius",d.Radius=f,e=!0));if(e)if(f=this._getValidatedValues(d,h,b)){if("Bearing"===h){h=this._getBearingAccordingToPlanSettings(f.BearingConversions);
d.Bearing=this._getBearingAccordingToPlanSettings(f.BearingConversions,!0);d.isTB&&(h="*"+h);a.set("value",h);var t=this._updateTBFromIndex(b+1)}else"Length"===h?(h=this._getRoundedValue(d.LengthConversions,"Length"),d.Length=d.LengthConversions[this._planSettings.distanceAndLengthUnits],d.RadiusConversions&&(d=this._createValuesForArc(d)),a.set("value",h),t=this._updateTBFromIndex(b)):"Radius"===h&&(d.RadiusConversions?(d.Radius=d.RadiusConversions[this._planSettings.distanceAndLengthUnits],h=this._getRoundedValue(d.RadiusConversions,
"Radius")):h=d.Radius="",d=this._createValuesForArc(d),a.set("value",h),t=this._updateTBFromIndex(b));this.appliedCompassRule?this.setParcelClosure(!0,!0):this.setStartPoint(this.startPoint,!0);if(t||c)this._reGenerateTraverseGrid(),c&&this._popupCoords&&this._openPopup(this._popupCoords)}else this._updateValues(d,h,a)}},_updateValues:function(a,b,c){if("Bearing"===b){a.Bearing=this._getBearingAccordingToPlanSettings(a.BearingConversions,!0);var d=this._getBearingAccordingToPlanSettings(a.BearingConversions)}else"Length"===
b?(a.Length=a.LengthConversions[this._planSettings.distanceAndLengthUnits],d=this._getRoundedValue(a.LengthConversions,"Length")):"Radius"===b&&(a.RadiusConversions?(a.Radius=a.RadiusConversions[this._planSettings.distanceAndLengthUnits],d=this._getRoundedValue(a.RadiusConversions,"Radius")):d=a.Radius="");c.set("value",d)},_showHideTraverseTools:function(){this._itemList&&0<this._itemList.length?(m.remove(this.expandCollapseNode,"esriCTHidden"),m.remove(this.zoomToNode,"esriCTHidden")):(m.add(this.expandCollapseNode,
"esriCTHidden"),m.add(this.zoomToNode,"esriCTHidden"))},_getBearingAccordingToPlanSettings:function(a,b){if("northAzimuth"===this._planSettings.directionOrAngleType&&"decimalDegree"===this._planSettings.directionOrAngleUnits)return b?a.naDD:a.naDDRound;if("northAzimuth"===this._planSettings.directionOrAngleType&&"degreeMinuteSeconds"===this._planSettings.directionOrAngleUnits)return a.naDMS;if("southAzimuth"===this._planSettings.directionOrAngleType&&"decimalDegree"===this._planSettings.directionOrAngleUnits)return b?
a.saDD:a.saDDRound;if("southAzimuth"===this._planSettings.directionOrAngleType&&"degreeMinuteSeconds"===this._planSettings.directionOrAngleUnits)return a.saDMS;if("quadrantBearing"===this._planSettings.directionOrAngleType&&"decimalDegree"===this._planSettings.directionOrAngleUnits)return b?a.qb3DD:a.qb3DDRound;if("quadrantBearing"===this._planSettings.directionOrAngleType&&"degreeMinuteSeconds"===this._planSettings.directionOrAngleUnits)return a.qb3DMS},_getRoundedValue:function(a,b){a=a[this._planSettings.distanceAndLengthUnits];
switch(b){case "Length":var c=this.lengthFieldPlaces;break;case "Radius":c=this.radiusFieldPlaces;break;case "MiscloseDistance":c=this.miscloseDistanceFieldPlaces}return n.honourPopupRounding(c,a)},_resetEntryRow:function(a){this.bearingNode.set("value","");this.lengthNode.set("value","");this.radiusNode.set("value","");this.bearingNode.reset();this.lengthNode.reset();this.radiusNode.reset();0<this._itemList.length&&(a=this._itemList[this._itemList.length-1].isTB?"*tb":a?this._getBearingAccordingToPlanSettings(this._itemList[this._itemList.length-
1].BearingConversions):this._itemList[this._itemList.length-1].Bearing,this.bearingNode.set("value",a),this.bearingNode.textbox.setSelectionRange(0,a.length))},_reGenerateTraverseGrid:function(){this._dndContainer&&(this._dndContainer.destroy(),this._dndContainer=null);r.empty(this.traverseGrid);this._createTraverseGrid()},_showRotationPoint:function(){var a=this.startPoint;if(this.config.startOrRotaionSymbol)var b=z.fromJson(this.config.startOrRotaionSymbol);else{var c={color:[136,136,136,255],size:11.25,
angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[29,29,53,255],width:.75,type:"esriSLS",style:"esriSLSSolid"}};b=z.fromJson(c)}this._rotationPointInfo&&this._rotationPointInfo.rotationPoint&&(a=this._rotationPointInfo.rotationPoint);4326!==this.map.spatialReference.wkid?k.getProjectedGeometry(a,this.map.spatialReference,this.geometryService).then(g.hitch(this,function(d){d&&(d=new x(d),d.setSymbol(b),this.rotationPointsGraphicsLayer.clear(),this.rotationPointsGraphicsLayer.add(d))})):
(c=new x(a),c.setSymbol(b),this.rotationPointsGraphicsLayer.clear(),this.rotationPointsGraphicsLayer.add(c))},resetRotationPoint:function(a){this._setRotationPoint(0,a)},_setRotationPoint:function(a,b){var c=b;b=new y(4326);k.getProjectedGeometry(c,b,this.geometryService).then(g.hitch(this,function(d){c=d;this._rotationPointInfo={rotationPointIndex:a,rotationPoint:c}}))},_updateStartPointFromRotationPoint:function(){var a=this._rotationPointInfo.rotationPoint,b=this._rotationPointInfo.rotationPointIndex;
if(null!==this._rotationAngle){for(--b;0<=b;b--){var c=this._itemList[b];var d=Number(c.BearingConversions.naDD)+this._rotationAngle;var e=c.LengthConversions.meters;this._scaleValue&&(e*=this._scaleValue);d=n.getSouthAzimuthFromNorthAzimuth(d);""===c.Radius||"0"===c.Radius||0===c.Radius?a=k.getDestinationPoint(a,d,e):(e=c.RadiusConversions.meters,c=c.ChordLengthConversions.meters,this._scaleValue&&(e*=this._scaleValue,c*=this._scaleValue),a=this.getArcInfo(a,d,e,c),a=a.endPoint)}this.setStartPoint(a)}},
_reDrawParcel:function(){this.parcelLinesGraphicsLayer.clear();this.parcelPointsGraphicsLayer.clear();this._arrayOfAllBoundaryLines=[];this._drawPoint(this.startPoint);w.forEach(this._itemList,g.hitch(this,function(a){""===a.Radius||"0"===a.Radius||0===a.Radius?this._drawStraightLine(a,!1):this._drawArc(a,!1)}));this._setExtentToLayer(this.parcelLinesGraphicsLayer);this.setParcelClosure()},setStartPoint:function(a,b,c,d){var e=new y(4326);k.getProjectedGeometry(a,e,this.geometryService).then(g.hitch(this,
function(f){c&&this._rotationPointInfo?(this._setRotationPoint(this._rotationPointInfo.rotationPointIndex,f),this._updateStartPointFromRotationPoint()):(this.startPoint=f,b&&this.resetRotationPoint(this.startPoint),this._showRotationPoint(),this._startPointForNextLine=g.clone(f),this._orgStartPointForNextLine=g.clone(f),this.appliedCompassRule=!1,0<this._itemList.length?this._reDrawParcel():(this.parcelPointsGraphicsLayer.clear(),this.parcelLinesGraphicsLayer.clear(),this._arrayOfAllBoundaryLines=
[],this._drawPoint(a,d)))}))},_addProjectedGraphic:function(a,b,c,d){var e,f={},h=c.setExtentToLayer,t=c.setParcelClosure,B=c.startNewTraverseBtnClick;f.rowIndex=d?d.rowIndex:a.graphics.length;b.attributes=f;4326!==this.map.spatialReference.wkid?k.getProjectedGeometry(b.geometry,this.map.spatialReference,this.geometryService).then(g.hitch(this,function(v){v&&(e=new x(v),e.setAttributes(f),e.setSymbol(b.symbol),a.add(e),d&&(d.graphic=e),B&&a.graphics&&0<a.graphics.length&&this.map.centerAt(a.graphics[0].geometry),
h&&(this._setExtentToLayer(a),t&&this.setParcelClosure()))})):(a.add(b),B&&a.graphics&&0<a.graphics.length&&this.map.centerAt(a.graphics[0].geometry),h&&(this._setExtentToLayer(a),t&&this.setParcelClosure()))},_drawPoint:function(a,b){a=new x(a,z.fromJson(this.config.pointSymbol));this._addProjectedGraphic(this.parcelPointsGraphicsLayer,a,{setExtentToLayer:!1,setParcelClosure:!1,startNewTraverseBtnClick:b})},_drawLineAndEndPoint:function(a,b,c,d){var e=!0;a?(b=k.getLineBetweenPoints(b))?(b=new x(b,
z.fromJson(c.LineSymbol.symbol)),this._addProjectedGraphic(this.parcelLinesGraphicsLayer,b,{setExtentToLayer:d,setParcelClosure:!0,startNewTraverseBtnClick:!1},c),this._startPointForNextLine=g.clone(a),this.appliedCompassRule&&this.parcelLinesGraphicsLayer.graphics.length===this._itemList.length&&(e=!1),e&&this._drawPoint(a)):this._showMessage(this.nls.newTraverse.unableToDrawLineMessage):this._showMessage(this.nls.newTraverse.invalidEndPointMessage)},setInfoForCalculatingMisclose:function(a,b,c){a.startPoint=
g.clone(this._orgStartPointForNextLine);a.endpoint=g.clone(b);c=k.getLineBetweenPoints(c);if(a.LineSymbol.type===this.config.BoundaryLineType)for(var d=0;d<c.paths.length;d++)this._arrayOfAllBoundaryLines.push(c.paths[d]);this._orgStartPointForNextLine=g.clone(b);return a},getArcInfo:function(a,b,c,d){var e=k.getDestinationPoint(a,b,Math.abs(d));var f=Math.abs(d)/2;var h=k.getDestinationPoint(a,b,f);a={distance:d,radius:c,initBearing:b,chordMidPoint:h,centerAndChordDistance:Math.sqrt(Math.abs(c*c-
f*f)),chordEndPoint:e,chordStartPoint:a};b=k.getArcParam(a);b.startAngle=b.startAngle>b.endAngle?b.startAngle-360:b.startAngle;b=k.getPointsForArc(b.startAngle,b.endAngle,b.centerPoint,c);0===b.length&&(b.push(a.chordStartPoint),b.push(a.chordEndPoint));0>c&&b.reverse();return{endPoint:e,arcGeometryPointsArray:b}},_drawStraightLine:function(a,b){var c=a.BearingConversions.naDD;var d=a.LengthConversions.meters;if(a.adjustedValues&&this.adjustPoints){c=a.adjustedValues.adjustedBearing;if("S"===a.BearingConversions.qb3DDRound.charAt(0)||
0>a.adjustedValues.lat)c=a.adjustedValues.adjustedBearingNADD;d=a.adjustedValues.adjustedLength;this.appliedCompassRule=!0}this._rotationAngle&&(c=Number(c)+this._rotationAngle);this._scaleValue&&(d*=this._scaleValue);var e=k.getDestinationPoint(this._orgStartPointForNextLine,a.BearingConversions.naDD,a.LengthConversions.meters);c=k.getDestinationPoint(this._startPointForNextLine,c,d);a=this.setInfoForCalculatingMisclose(a,e,[this._orgStartPointForNextLine,e]);this._drawLineAndEndPoint(c,[this._startPointForNextLine,
c],a,b)},_drawArc:function(a,b){var c=a.BearingConversions.naDD;var d=a.RadiusConversions.meters;var e=a.ChordLengthConversions.meters;if(a.adjustedValues&&this.adjustPoints){c=a.adjustedValues.adjustedBearing;if("S"===a.BearingConversions.qb3DDRound.charAt(0)||0>a.adjustedValues.lat)c=a.adjustedValues.adjustedBearingNADD;e=a.adjustedValues.adjustedLength;0>a.ChordLengthConversions.meters&&(e*=-1);this.appliedCompassRule=!0}this._rotationAngle&&(c=Number(c)+this._rotationAngle);this._scaleValue&&
(e*=this._scaleValue,d*=this._scaleValue);var f=this.getArcInfo(this._orgStartPointForNextLine,a.BearingConversions.naDD,a.RadiusConversions.meters,a.ChordLengthConversions.meters);a=this.setInfoForCalculatingMisclose(a,f.endPoint,f.arcGeometryPointsArray);d=this.getArcInfo(this._startPointForNextLine,c,d,e);this._drawLineAndEndPoint(d.endPoint,d.arcGeometryPointsArray,a,b)},_setExtentToLayer:function(a,b){this._setExtentTimer&&clearTimeout(this._setExtentTimer);this._setExtentTimer=setTimeout(g.hitch(this,
function(){if(0<a.graphics.length){var c=R.graphicsExtent(a.graphics);!b&&this.map.extent.contains(c)||this.map.setExtent(c.expand(1.5))}}),200)},_showMessage:function(a){this.emit("showMessage",a)},updateAccordingToPlanSettings:function(a){this._planSettings=a;this.bearingNode.set("placeHolder",this._getAbbreviatedUnits(a.directionOrAngleUnits));this.lengthNode.set("placeHolder",this._getAbbreviatedUnits(a.distanceAndLengthUnits));this.radiusNode.set("placeHolder",this._getAbbreviatedUnits(a.distanceAndLengthUnits));
this._reGenerateTraverseGrid();this._misCloseDetailsInstance&&(a=this._misCloseDetailsInstance.getMiscloseDetails())&&(a=this._getMiscloseDetailsAccordingToPlanSettings(a),this._misCloseDetailsInstance.updateAccordingToPlanSettings(a))},deActivateUpdateRotationPointTool:function(){m.remove(this.updateRotationPointNode,"esriCTEnableButton");l.set(this.updateRotationPointNode,"aria-pressed","false")},deActivateDigitizationTool:function(){m.remove(this.screenDigitizationNode,"esriCTEnableButton");l.set(this.screenDigitizationNode,
"aria-pressed","false")},pointAddedFromDigitization:function(a){var b,c,d;var e=new y(4326);k.getProjectedGeometry(a,e,this.geometryService).then(g.hitch(this,function(f){b=k.getAngleBetweenPoints(this._startPointForNextLine,f);360===b&&(b=0);c=k.getDistanceBetweenPoints(this._startPointForNextLine,f);d=this.getAngleFromDDTOQB(b);this.bearingNode.set("value",d);"uSSurveyFeet"===this._planSettings.distanceAndLengthUnits?c=n.metersToUSSurveyFeet(c):"feet"===this._planSettings.distanceAndLengthUnits&&
(c=n.metersToFeet(c));0<this._scaleValue&&(c/=this._scaleValue);this.lengthNode.set("value",c);this.radiusNode.set("value","");this._addNewItem(!0)}))},getParcelCloseDetails:function(){var a,b,c,d;var e={isClosed:!1,compassStartPoint:null,compassEndPoint:null};var f=!0;var h=a=b=0;w.forEach(this._itemList,g.hitch(this,function(v,W){v.LineSymbol.type===this.config.BoundaryLineType?(0===b?c=v.startPoint:d=v.endpoint,b++,a+=Math.cos(v.BearingConversions.naDD/180*Math.PI)*v.LengthConversions.meters,h+=
Math.sin(v.BearingConversions.naDD/180*Math.PI)*v.LengthConversions.meters):0<W&&0!==b&&(f=!1)}));if(1<b&&f){var t=Math.sqrt(a*a+h*h);t=k.removeNegativeExponents(t);c.x=n.showFixedPlacesAfterDecimal(c.x,6);c.y=n.showFixedPlacesAfterDecimal(c.y,6);d.x=n.showFixedPlacesAfterDecimal(d.x,6);d.y=n.showFixedPlacesAfterDecimal(d.y,6);var B=k.getAngleBetweenPoints(d,c);e.isClosed=!0;e.compassStartPoint=c;e.compassEndPoint=d;e.miscloseDistance=t;e.miscloseBearing=B}return e},setParcelClosure:function(a,b){var c=
this.getParcelCloseDetails();if(c.isClosed)c=this.getCalculatedMiscloseDetails(c),this._misCloseDetailsInstance.setMiscloseDetails(c),c.adjustPoints?((this.adjustPoints=this._applyCompassRule(c))&&!this.appliedCompassRule||a)&&this.setStartPoint(this.startPoint,b):(this.adjustPoints=!1,(this.appliedCompassRule||a)&&this.setStartPoint(this.startPoint,b));else if(this._misCloseDetailsInstance.setMiscloseDetails(null),this.adjustPoints=!1,this.appliedCompassRule||a)this.appliedCompassRule=!1,this.setStartPoint(this.startPoint,
b)},_getMiscloseDetailsAccordingToPlanSettings:function(a){var b={};a.BearingConversions&&(b.miscloseBearing=this._getBearingAccordingToPlanSettings(a.BearingConversions));var c=this._getRoundedValue(a.LengthConversions,"MiscloseDistance");b.miscloseDistance=c+" "+this._getAbbreviatedUnits(this._planSettings.distanceAndLengthUnits);a.AreaConversions?(a=a.AreaConversions[this._planSettings.areaUnits],isNaN(parseFloat(a))||(a=n.honourPopupRounding(2,a.toFixed(1)))):a=0;a=a+" "+this._getAbbreviatedUnits(this._planSettings.areaUnits);
b.calculatedArea=a;return b},getCalculatedMiscloseDetails:function(a){var b,c={},d=b=0;d=0;var e=!1;b=a.compassStartPoint;if(a.compassEndPoint&&b){b=a.miscloseDistance;d=a.miscloseBearing;0===b&&(d=0);d=this.getAngleFromDDTOQB(d);if(a=n.categorizeBearingFormat(d,this._planSettings))c.BearingConversions=a;c.AreaConversions=this._getCalculatedArea();a=this._getMiscloseRatioInfo(b);d=a.miscloseRatio;c.miscloseValue=a.miscloseValue;b=n.categorizeLengthFormat(b,"meters");c.LengthConversions=b;b=b[this.config.miscloseSnapDistanceUnit+
"Round"];1E5<=d&&(e=!0);c.miscloseRatio=d;c.accuracy=e;c=g.mixin(c,this._getMiscloseDetailsAccordingToPlanSettings(c));if(0<b&&b<=this.config.miscloseSnapDistance||isFinite(d)&&d>=this.config.miscloseRatioSnap)c.adjustPoints=!0,c.compassCompleteLength=a.compassCompleteLength}return c},_getPolygonAtOrigin:function(){var a=new V(0,0,new y(4326)),b=[];w.forEach(this._itemList,g.hitch(this,function(c){if(c.LineSymbol.type===this.config.BoundaryLineType){if(""===c.Radius||"0"===c.Radius||0===c.Radius){if(c.adjustedValues&&
this.adjustPoints){var d=c.adjustedValues.adjustedBearing;if("S"===c.BearingConversions.qb3DDRound.charAt(0)||0>c.adjustedValues.lat)d=c.adjustedValues.adjustedBearingNADD;var e=c.adjustedValues.adjustedLength}else d=c.BearingConversions.naDD,e=c.LengthConversions.meters;c=k.getDestinationPoint(a,d,e);e=k.getLineBetweenPoints([a,c])}else{if(c.adjustedValues&&this.adjustPoints){d=c.adjustedValues.adjustedBearing;if("S"===c.BearingConversions.qb3DDRound.charAt(0)||0>c.adjustedValues.lat)d=c.adjustedValues.adjustedBearingNADD;
e=c.adjustedValues.adjustedLength;0>c.ChordLengthConversions.meters&&(e*=-1)}else d=c.BearingConversions.naDD,e=c.ChordLengthConversions.meters;e=this.getArcInfo(a,d,c.RadiusConversions.meters,e);c=e.endPoint;e=k.getLineBetweenPoints(e.arcGeometryPointsArray)}a=c;for(c=0;c<e.paths.length;c++)b.push(e.paths[c])}}));return k.getPolygonFromPolyLines(b,!0)},_getCalculatedArea:function(){var a;if(this._arrayOfAllBoundaryLines&&0<this._arrayOfAllBoundaryLines.length&&(a=this._getPolygonAtOrigin())){var b=
new x(a);this.parcelPolygonGraphicsLayer.clear();this.parcelPolygonGraphicsLayer.add(b);b=k.getAreaOfGeometry(a)}return b},_applyCompassRule:function(a){var b,c;var d=c=0;var e={};for(b=0;b<this._itemList.length;b++){var f=this._itemList[b];if(f.LineSymbol.type===this.config.BoundaryLineType){if(""===f.Radius||"0"===f.Radius||0===f.Radius)var h=f.LengthConversions.meters;else f.ChordLengthConversions&&(h=f.ChordLengthConversions.meters);h=Math.abs(h);f.lat=h*Math.cos(Math.PI/180*f.BearingConversions.naDD);
f.dep=h*Math.sin(Math.PI/180*f.BearingConversions.naDD);c+=f.lat;d+=f.dep}}e.sumOfLat=c;e.sumOfDep=d;e.sumOfAllLinesLength=a.compassCompleteLength;for(b=0;b<this._itemList.length;b++)f=this._itemList[b],""===f.Radius||"0"===f.Radius||0===f.Radius?h=f.LengthConversions.meters:f.ChordLengthConversions&&(h=f.ChordLengthConversions.meters),h=Math.abs(h),f.LineSymbol.type===this.config.BoundaryLineType&&(f.adjustedValues=this._adjustBearingAndDistance(f.lat,f.dep,h,e));for(b=h=a=0;b<this._itemList.length;b++)f=
this._itemList[b],f.LineSymbol.type===this.config.BoundaryLineType&&(a+=parseFloat(f.adjustedValues.lat.toFixed(2)),h+=parseFloat(f.adjustedValues.dep.toFixed(2)),a=parseFloat(a.toFixed(2)),h=parseFloat(h.toFixed(2)));return 0===parseInt(a,10)&&0===parseInt(h,10)?!0:!1},_adjustBearingAndDistance:function(a,b,c,d){var e={};a=parseFloat(a.toFixed(6));b=parseFloat(b.toFixed(6));c=parseFloat(c.toFixed(6));var f=-d.sumOfLat/d.sumOfAllLinesLength*c;c*=-d.sumOfDep/d.sumOfAllLinesLength;f=parseFloat(f.toFixed(6));
c=parseFloat(c.toFixed(6));b+=c;a=parseFloat((a+f).toFixed(6));b=parseFloat(b.toFixed(6));f=Math.sqrt(Math.pow(a,2)+Math.pow(b,2));c=Math.atan(b/a);c=parseFloat(c.toFixed(6));e.lat=a;e.dep=b;e.adjustedLength=f;e.adjustedBearing=180/Math.PI*c;a=n.categorizeBearingFormat(e.adjustedBearing,{directionOrAngleType:"southAzimuth",directionOrAngleUnits:"decimalDegree"});e.adjustedBearingNADD=a.naDD;return e},_getMiscloseRatioInfo:function(a){var b,c=b=0;var d=0;this._arrayOfAllBoundaryLines&&0<this._arrayOfAllBoundaryLines.length&&
(b=k.getPolyLineFromPaths(this._arrayOfAllBoundaryLines),b=k.getLengthOfGeometry(b),0<b&&(c=1/(a/b),10>c?c=0:1E5>c&&(d=parseInt(c,10),c="1:"+parseInt(c,10))));return{miscloseRatio:c,miscloseValue:d,compassCompleteLength:b}},getAngleFromDDTOQB:function(a){var b;var c=g.clone(this._planSettings);c.directionOrAngleType="northAzimuth";c.directionOrAngleUnits="decimalDegree";(a=n.categorizeBearingFormat(a,c))&&(b="degreeMinuteSeconds"===this._planSettings.directionOrAngleUnits?a.qb3DMS:a.qb3DD);return b},
initEditing:function(a,b,c){var d;this._planInfoInstance.setParcelInformation(this.polygonDeleteArr,b.features);var e=this.polygonDeleteArr[0].attributes[this.config.polygonLayer.rotation.name];(d=this.polygonDeleteArr[0].attributes[this.config.polygonLayer.scale.name])||(d=1);var f=this.polygonDeleteArr[0].attributes[this.config.polygonLayer.statedArea.name];this._parcelToolInstance.setRotation(e);this._parcelToolInstance.setScale(d);null!==f&&void 0!==f&&this._misCloseDetailsInstance.traverseStatedArea.set("value",
f);d=[];var h=k.getUnitValueForSR(c);var t=g.clone(this._planSettings);t.directionOrAngleType="northAzimuth";t.directionOrAngleUnits="decimalDegree";for(c=0;c<b.features.length;c++)if(e={},e.Bearing=b.features[c].attributes[this.config.polylineLayer.bearing.name],null!==e.Bearing&&void 0!==e.Bearing&&""!==e.Bearing){e.BearingConversions=n.categorizeBearingFormat(e.Bearing,t);e.Bearing=this._getBearingAccordingToPlanSettings(e.BearingConversions,!0);e.Length=b.features[c].attributes[this.config.polylineLayer.distance.name];
null!==e.Length&&""!==e.Length&&(e.LengthConversions=this._validateLength(e.Length,h),e.Length=e.LengthConversions[this._planSettings.distanceAndLengthUnits]);if(f=this.getLineSymbolForType(b.features[c].attributes[this.config.polylineLayer.lineType.name]))e.LineSymbol=f;e.Radius=b.features[c].attributes[this.config.polylineLayer.radius.name];null!==e.Radius&&""!==e.Radius?(e.RadiusConversions=this._validateLength(e.Radius,h),e.Radius=e.RadiusConversions[this._planSettings.distanceAndLengthUnits],
e.ArcLength=b.features[c].attributes[this.config.polylineLayer.arcLength.name],null!==e.ArcLength&&""!==e.ArcLength&&(e.ArcLengthConversions=this._validateLength(e.ArcLength,h),e.ArcLength=e.ArcLengthConversions[this._planSettings.distanceAndLengthUnits]),e.ChordLength=b.features[c].attributes[this.config.polylineLayer.chordLength.name],null!==e.ChordLength&&""!==e.ChordLength&&(e.ChordLengthConversions=this._validateLength(e.ChordLength,h),e.ChordLength=e.ChordLengthConversions[this._planSettings.distanceAndLengthUnits]),
"radiusAndArcLength"===this._planSettings.circularCurveParameters?(e.Length=e.ArcLength,e.LengthConversions=g.clone(e.ArcLengthConversions)):(e.Length=e.ChordLength,e.LengthConversions=g.clone(e.ChordLengthConversions))):(e.Radius="",e.RadiusConversions=null);e.rowIndex=d.length;d.push(e)}this._itemList=d;this._reGenerateTraverseGrid();this._showHideTraverseTools();this.setStartPoint(a,!0);this.setBoundaryLineSymbol()},setBoundaryLineSymbol:function(){this._symbolSelector&&w.some(this.config.lineTypes,
g.hitch(this,function(a){if(this.config.BoundaryLineType===a.type)return this._symbolSelector.selectSymbol(a),!1}))},getLineSymbolForType:function(a){var b;w.some(this.config.lineTypes,g.hitch(this,function(c){if(c.type===a)return b=g.clone(c),!0}));return b},deactivateParcelTools:function(){this._parcelToolInstance.disableRotating();this._parcelToolInstance.disableScaling()},clearAll:function(){this.parcelLinesGraphicsLayer.clear();this.parcelPointsGraphicsLayer.clear();this.parcelPolygonGraphicsLayer.clear();
this.rotationPointsGraphicsLayer.clear();this._resetEntryRow();this._dndContainer.clearItems();r.empty(this.traverseGrid);this._itemList=[];this._nodes=[];this._showHideTraverseTools();this._orgStartPointForNextLine=this._startPointForNextLine=this.startPoint=null;this._rotationAngle=0;this._scaleValue=1;this._symbolSelector.setDefault();m.remove(this.screenDigitizationNode,"esriCTEnableButton");m.remove(this.updateRotationPointNode,"esriCTEnableButton");this._parcelToolInstance.resetTools();this.deactivateParcelTools();
this._misCloseDetailsInstance.setMiscloseDetails(null);this._arrayOfAllBoundaryLines=[];this.polygonDeleteArr=[];this.polylineDeleteArr=[];this.domNode.scrollTop=0;this._planInfoInstance.resetValues();this._misCloseDetailsInstance.traverseStatedArea.set("value",null);this._rotationPointInfo=null;this.closePopup()},_showParcelPopup:function(a){var b=[];var c=new T;var d=this._pointToExtent(a.mapPoint,8);b=w.filter(this.parcelLinesGraphicsLayer.graphics,function(e){return d.intersects(e.geometry)});
b[0]?(this._createPopupContent(a,b[0]),c.resolve(!0)):(this.closePopup(),c.resolve(!1));return c},_getAbbreviatedUnits:function(a){return window.jimuNls.units[a+"Abbr"]},_pointToExtent:function(a,b){var c=this.map.extent.getWidth()/this.map.width;b*=c;return new U(a.x-b,a.y-b,a.x+b,a.y+b,this.map.spatialReference)},_createPopupContent:function(a,b){var c;if(c=this._itemList[b.attributes.rowIndex]){var d=r.create("div",{"class":"esriCTParcelInfoPopup "+this.baseClass},null);var e=r.create("div",{"class":"esriCTLabelRows"},
d);this._createFieldLabels(e,this.nls.traverseSettings.bearingLabel);this._createFieldLabels(e,this.nls.traverseSettings.lengthLabel);this._createFieldLabels(e,this.nls.traverseSettings.radiusLabel);b=r.create("div",{"class":"esriCTRowContainer esriCTRow",rowIndex:b.attributes.rowIndex},d);this._createFieldInputs(b,this._getBearingAccordingToPlanSettings(c.BearingConversions),"esriCTBearingRow",!0);(e=c.RadiusConversions)?(e=this._getRoundedValue(c.RadiusConversions,"Radius"),c="radiusAndArcLength"===
this._planSettings.circularCurveParameters?this._getRoundedValue(c.ArcLengthConversions,"Length"):this._getRoundedValue(c.ChordLengthConversions,"Length")):(e="",c=this._getRoundedValue(c.LengthConversions,"Length"));this._createFieldInputs(b,c,"esriCTLengthRow",!0);this._createFieldInputs(b,e,"esriCTRadiusRow",!0);D.position(this.traverseEntryNode)&&D.position(this.traverseEntryNode).w&&(c=D.position(this.traverseEntryNode).w-42,E.set(this._popupDialog.domNode,"width",c+"px"));this._popupDialog.setContent(d);
this._popupCoords={pageX:a.pageX,pageY:a.pageY};this._openPopup(a)}},_openPopup:function(a){E.set(this._popupDialog.domNode,"opacity",.9);F.open({popup:this._popupDialog,x:a.pageX,y:a.pageY})},closePopup:function(){this._popupDialog&&F.close(this._popupDialog)},_createFieldLabels:function(a,b){r.create("div",{innerHTML:b,title:b,"class":"esriCTParcelInfoLabels"},a)},_createTooltip:function(){this._popupDialog=new S({"class":"esriCTEditParcelDialog"});this._popupDialog.startup()},validateNumericField:function(a,
b){var c=/^[-+]?[0-9]+\.[0-9]+$/,d=/^[-+]?[0-9]+$/;a=g.trim(a);switch(b){case "esriFieldTypeSmallInteger":b=parseInt(a,10);var e=a.match(d)&&-32768<=b&&32767>=b&&0!==a.length?!0:!1;break;case "esriFieldTypeInteger":b=parseInt(a,10);e=a.match(d)&&-2147483648<=b&&2147483647>=b&&0!==a.length?!0:!1;break;case "esriFieldTypeSingle":b=parseFloat(a);e=(a.match(d)||a.match(c))&&b>=-3.4*Math.pow(10,38)&&b<=1.2*Math.pow(10,38)&&0!==a.length?!0:!1;break;case "esriFieldTypeDouble":b=parseFloat(a),e=(a.match(d)||
a.match(c))&&b>=-2.2*Math.pow(10,308)&&b<=1.8*Math.pow(10,38)&&0!==a.length?!0:!1}return e},updateLastNodeInTraversePanel:function(){this._planInfoInstance.setPlanInfoCancelBtnAsLastNode()},_showParcelSavedAndDeleteMsg:function(a){this.emit("showParcelSavedAndDeleteMsg",a)}})});