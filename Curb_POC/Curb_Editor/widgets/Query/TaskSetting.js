// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
require({cache:{"url:widgets/Query/TaskSetting.html":'\x3cdiv tabindex\x3d"0" data-a11y-label-by\x3d"taskSettingName"\x3e\r\n  \x3ctable class\x3d"top"\x3e\r\n    \x3ctr\x3e\r\n      \x3ctd class\x3d"first-td"\x3e\r\n        \x3cdiv role\x3d"button" tabindex\x3d"0" aria-label\x3d"${nls.back}" class\x3d"back-arrow feature-action icon-arrow-back" data-dojo-attach-point\x3d"backArrow" data-dojo-attach-event\x3d"onclick:_onBtnParamsBackClicked,onkeydown:_onBtnParamsBackKeydown"\x3e\x3c/div\x3e\r\n      \x3c/td\x3e\r\n      \x3ctd class\x3d"second-td"\x3e\r\n        \x3cdiv class\x3d"task-name jimu-ellipsis" data-dojo-attach-point\x3d"taskNameDiv" data-a11y-label-id\x3d"taskSettingName"\x3e\x3c/div\x3e\r\n      \x3c/td\x3e\r\n      \x3ctd class\x3d"third-td"\x3e\x3c/td\x3e\r\n    \x3c/tr\x3e\r\n  \x3c/table\x3e\r\n  \x3cdiv class\x3d"content-container"\x3e\r\n\r\n    \x3cdiv class\x3d"params-container" data-dojo-attach-point\x3d"paramsContainer"\x3e\r\n      \x3cdiv tabindex\x3d"0" class\x3d"not-visible" data-dojo-attach-point\x3d"noFilterTip"\x3e${nls.noAttributeSpatialFilterTip}\x3c/div\x3e\r\n      \x3cdiv class\x3d"attributes-section" data-dojo-attach-point\x3d"attributesSectionDiv" data-a11y-label-by\x3d"queryCriteira-label queryCriteira-sql"\x3e\r\n        \x3cdiv data-dojo-attach-point\x3d"criteiraLabelDiv" class\x3d"first-stress attribute-filter-label" data-a11y-label-id\x3d"queryCriteira-label"\x3e${nls.queryCriteira}\x3c/div\x3e\r\n        \x3cdiv class\x3d"sql-div jimu-widget-note" data-dojo-attach-point\x3d"sqlDiv" data-a11y-label-id\x3d"queryCriteira-sql"\x3e\x3c/div\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv class\x3d"spatial-section" data-dojo-attach-point\x3d"spatialSectionDiv" data-a11y-label-by\x3d"spatialFilter-label spatialFilter-tip"\x3e\r\n        \x3cdiv tabindex\x3d"0" class\x3d"spearator not-visible" data-dojo-attach-point\x3d"spatialSpearator"\x3e\x3c/div\x3e\r\n        \x3cdiv data-dojo-attach-point\x3d"spatialFilterLabelDiv" class\x3d"first-stress spatial-filter-label" data-a11y-label-id\x3d"spatialFilter-label"\x3e${nls.spatialFilter}\x3c/div\x3e\r\n        \x3cdiv class\x3d"spatial-filter-tip" data-dojo-attach-point\x3d"spatialFilterTip" data-a11y-label-id\x3d"spatialFilter-tip"\x3e\x3c/div\x3e\r\n        \x3cselect data-dojo-type\x3d"jimu/dijit/formSelect" data-a11y-label-by\x3d"spatialFilter-label spatialFilter-tip" data-dojo-attach-point\x3d"spatialTypeSelect" data-dojo-attach-event\x3d"change:_onSpatialTypeSelectChanged" class\x3d"restrict-select-width" style\x3d"width:100%;box-sizing:border-box;"\x3e\x3c/select\x3e\r\n\r\n        \x3cdiv class\x3d"spatial-filter-content" data-dojo-attach-point\x3d"spatialFilterContent"\x3e\r\n          \x3cdiv class\x3d"drawing-section" data-dojo-attach-point\x3d"drawingSection"\x3e\x3c/div\x3e\r\n          \x3cdiv class\x3d"features-section" data-dojo-attach-point\x3d"featuresSection"\x3e\r\n            \x3cdiv class\x3d"relationship-section"\x3e\r\n              \x3cdiv class\x3d"second-stress relationship-tip" data-a11y-label-id\x3d"spatialRelationship"\x3e${nls.spatialRelationship}\x3c/div\x3e\r\n              \x3cselect data-dojo-attach-point\x3d"relationshipSelect" data-a11y-label-by\x3d"spatialRelationship" data-dojo-type\x3d"jimu/dijit/formSelect" class\x3d"restrict-select-width relationship-select" style\x3d"width:100%;box-sizing:border-box;"\x3e\x3c/select\x3e\r\n            \x3c/div\x3e\r\n          \x3c/div\x3e\r\n        \x3c/div\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n\r\n    \x3cdiv data-dojo-attach-point\x3d"layerNameContainer" class\x3d"result-name-container"\x3e\r\n      \x3cdiv class\x3d"first-stress" data-a11y-label-id\x3d"layerName" \x3e${nls.layerName}\x3c/div\x3e\r\n      \x3cdiv class\x3d"result-name-text" data-a11y-label-by\x3d"layerName" data-dojo-attach-point\x3d"layerNameTextBox" data-dojo-type\x3d"dijit/form/TextBox" data-dojo-attach-event\x3d"change:_onLayerNameTextChanged"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n\r\n  \x3cdiv role\x3d"button" tabindex\x3d"0" class\x3d"jimu-btn btn-execute" data-dojo-attach-point\x3d"btnExecute" data-dojo-attach-event\x3d"onclick:_onBtnApplyClicked,onkeydown:_onBtnApplyKeydown"\x3e${nls.apply}\x3c/div\x3e\r\n  \x3cdiv data-dojo-attach-point\x3d"shelter" data-dojo-type\x3d"jimu/dijit/LoadingIndicator" data-dojo-props\x3d\'hidden:true\'\x3e\x3c/div\x3e\r\n\x3c/div\x3e'}});
define("dojo/_base/declare dijit/_WidgetBase jimu/dijit/BindLabelPropsMixin dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dojo/Evented dojo/text!./TaskSetting.html dojo/on dojo/keys dojo/Deferred dojo/_base/lang dojo/_base/html dojo/_base/array dojo/promise/all jimu/filterUtils jimu/dijit/FilterParameters ./utils jimu/utils ./SingleQueryLoader ./SpatialFilterByDrawing jimu/dijit/SpatialFilterByFeatures esri/tasks/query esri/dijit/PopupTemplate jimu/dijit/formSelect".split(" "),function(v,w,
x,y,z,A,B,k,n,r,h,g,p,C,D,E,q,l,F,G,H,I,J){return v([w,x,y,z,A],{baseClass:"query-task-setting",templateString:B,askForValues:!1,_defaultRelationship:"SPATIAL_REL_INTERSECTS",nls:null,map:null,currentAttrs:null,layerInfosObj:null,postMixInProperties:function(){this.inherited(arguments);this.isRenderIdForAttrs=!0;this.nls.back=window.jimuNls.common.back},postCreate:function(){this.inherited(arguments);this._initSelf()},run:function(){var a=this._getCleanClonedCurrentAttrs(this.currentAttrs);a.query.relationship=
this._getRestRelationship();var c=this.getWhere(),d=this.getGeometry();C([c,d]).then(h.hitch(this,function(e){this.deactivate();a.query.where=e[0];a.query.geometry=e[1];if("function"===typeof this.onApply)this.onApply(a)}),h.hitch(this,function(e){console.error(e)}))},hideTempLayers:function(){this.spatialFilterByDrawing&&this.spatialFilterByDrawing.hideTempLayers();this.spatialFilterByFeatures&&this.spatialFilterByFeatures.hideTempLayers()},showTempLayers:function(){this.spatialFilterByDrawing&&
this.spatialFilterByDrawing.showTempLayers();this.spatialFilterByFeatures&&this.spatialFilterByFeatures.showTempLayers()},_getDrawingInfoForLayerInfo:function(a,c){var d=a.drawingInfo;(c=c.renderer&&c.renderer.toJson())&&l.isUniqueReneredByLayerObject(c,l.getUniqueRendererByLayerDefinition(a))&&(d.renderer=h.clone(c));return d},_getCleanClonedCurrentAttrs:function(a){var c=F.getCleanCurrentAttrsTemplate(),d=null,e;for(e in a)if("queryTr"!==e&&"query"!==e&&"layerObject"!==e)if(d=a[e],"relationshipPopupTemplates"===
e){for(var b in d)d[b]=new J(d[b].toJson());c[e]=d}else"layerInfo"===e&&a.layerObject&&(d.drawingInfo=this._getDrawingInfoForLayerInfo(d,a.layerObject)),c[e]=h.clone(d);c.queryTr=a.queryTr;c.query.maxRecordCount=a.query.maxRecordCount;return c},onGetQueryResponse:function(){this.deactivate();this._tryResetSpatialFilterByDrawing();this._tryResetSpatialFilterByFeatures()},getWhere:function(){var a=new r,c=this._getWhereInfo();if(1===c.status){var d=this.currentAttrs.config.webMapLayerId;if(d){var e=
null;e=q.isTable(this.currentAttrs.layerInfo)?this.layerInfosObj.getTableInfoById(d):this.layerInfosObj.getLayerInfoById(d);d="";e&&(d=e.getFilter());e=c.where;d&&(e="("+d+") AND ("+c.where+")");a.resolve(e)}else a.resolve(c.where)}else a.reject("Can't get a valid sql");return a},_getWhereInfo:function(){var a={status:0,where:""};if(this.askForValues){var c=this.filterParams.getFilterExpr();c&&"string"===typeof c?(a.status=1,a.where=c):(a.status=-1,a.where=null)}else a.status=1,a.where=this.currentAttrs.config.filter.expr;
1!==a.status||a.where||(a.where="1\x3d1");return a},_updateExecuteButtonStatus:function(){var a=this._isValidWhereToExecute()&&this._isValidGeometryToExecute()&&this._isValidLayerNameToExecute();a?g.removeClass(this.btnExecute,"disabled"):g.addClass(this.btnExecute,"disabled");return a},_isValidWhereToExecute:function(){return 0<this._getWhereInfo().status},_isValidLayerNameToExecute:function(){return this.layerNameTextBox.get("value")},_isValidGeometryToExecute:function(){var a=this.spatialTypeSelect.get("value");
if("currentMapExtent"!==a){if("drawing"===a)return!!this.spatialFilterByDrawing.getGeometryInfo().geometry;if("useFeatures"===a)return this.spatialFilterByFeatures.isValidSearchDistance()}return!0},getGeometry:function(){var a=new r,c=this.spatialTypeSelect.get("value");"currentMapExtent"===c?a.resolve(this.map.extent):"drawing"===c?(c=this.spatialFilterByDrawing.getGeometryInfo(),0>c.status?a.reject("Invalid search distance"):(0===c.status&&console.log("User doesn't draw anything"),a.resolve(c.geometry))):
"useFeatures"===c?this.spatialFilterByFeatures.getGeometryInfo().then(h.hitch(this,function(d){-2===d.status?a.reject("Invalid search distance"):(-1===d.status?console.log("User doesn't select a layer"):0===d.status&&console.log("User doesn't select any features"),a.resolve(d.geometry))}),h.hitch(this,function(d){a.reject(d)})):a.resolve(null);return a},deactivate:function(){this.spatialFilterByDrawing&&this.spatialFilterByDrawing.deactivate();this.spatialFilterByFeatures&&this.spatialFilterByFeatures.deactivate()},
clearAllGraphics:function(){this.spatialFilterByDrawing&&this.spatialFilterByDrawing.clearAllGraphics();this.spatialFilterByFeatures&&this.spatialFilterByFeatures.clearAllGraphics()},canAutoRunning:function(){return this._canAttributeFilterAutoRunning()&&this._canSpatialFilterAutoRunning()},_canAttributeFilterAutoRunning:function(){return 0<this._getWhereInfo().status&&!this.askForValues},_canSpatialFilterAutoRunning:function(){var a=this.spatialTypeSelect.getOptions()||[];return 0===a.length?!0:
1===a.length?(a=this.spatialTypeSelect.get("value"),"drawing"!==a&&"useFeatures"!==a):!1},_initSelf:function(){var a=this.currentAttrs.config,c=this.currentAttrs.layerInfo,d=this.currentAttrs.layerObject||c,e=a.name||"";e=l.sanitizeHTML(e);this.taskNameDiv.innerHTML=e;this.taskNameDiv.title=this.taskNameDiv.innerHTML;a.customResultName?this._showLayerNameContainer():this._hideLayerNameContainer();if(this.showFilterLabel){var b=this.criteiraLabel||"";b=l.sanitizeHTML(b);this.criteiraLabelDiv.innerHTML=
b;this.criteiraLabelDiv.title=this.criteiraLabelDiv.innerHTML;b=this.spatialFilterLabel||"";b=l.sanitizeHTML(b);this.spatialFilterLabelDiv.innerHTML=b;this.spatialFilterLabelDiv.title=this.spatialFilterLabelDiv.innerHTML;this._showCriteiraLabelDiv();this._showSpatialFilterLabelDiv()}else this.criteiraLabelDiv.innerHTML="",this.criteiraLabelDiv.title="",this.spatialFilterLabelDiv.innerHTML="",this.spatialFilterLabelDiv.title="",this._hideCriteiraLabelDiv(),this._hideSpatialFilterLabelDiv();this.filterParams=
new E;this.filterParams.placeAt(this.sqlDiv,"before");var t={ifDisplaySQL:!0};this.own(k(this.filterParams,"change",h.hitch(this,this._updateExecuteButtonStatus)));this.own(k(this.filterParams,"enter",h.hitch(this,this._onBtnApplyClicked)));b=h.clone(a.filter);b.wId="widgets_Query_Widget"+this.wId+"_"+this.id;this.filterParams.build(a.url,d,b,a.webMapLayerId,this.id);d=new D;b=this.currentAttrs.config.filter;this.askForValues=d.isAskForValues(b);var f=!0;d=!1;if(this.askForValues){f=!0;b.displaySQL?
this.sqlDiv.innerHTML=b.displaySQL:b.expr&&(this.sqlDiv.innerHTML=b.expr);if(b=this.filterParams.getFilterExpr(t))this.sqlDiv.innerHTML=b;this.own(k(this.filterParams,"change",h.hitch(this,function(){this.sqlDiv.innerHTML="";var m=this.filterParams.getFilterExpr(t);m&&this.currentAttrs.config.showSQL&&(this.sqlDiv.innerHTML=m)})))}else this.currentAttrs.config.showSQL?f="1\x3d1"!==b.expr:(f=!1,d="1\x3d1"===b.expr),this.sqlDiv.innerHTML=b.displaySQL?b.displaySQL:b.expr;this.currentAttrs.config.showSQL?
g.removeClass(this.sqlDiv,"not-visible"):(this.sqlDiv.innerHTML="",g.addClass(this.sqlDiv,"not-visible"));f?(g.removeClass(this.attributesSectionDiv,"not-visible"),(this.showFilterLabel&&""!==this.criteiraLabelDiv.innerHTML||this.currentAttrs.config.showSQL)&&g.setAttr(this.attributesSectionDiv,"tabindex","0")):g.addClass(this.attributesSectionDiv,"not-visible");b=this.currentAttrs.config.spatialFilter;f=null;b||(b={});q.isTable(c)&&(b={});b.currentMapExtent&&(f={value:"currentMapExtent",label:this.nls.useCurrentExtentTip},
this.spatialTypeSelect.addOption(f),b.currentMapExtent["default"]&&this.spatialTypeSelect.set("value",f.value));b.drawing&&(f={value:"drawing",label:this.nls.useDrawGraphicTip},this.spatialTypeSelect.addOption(f),b.drawing["default"]&&this.spatialTypeSelect.set("value",f.value),f=b.drawing.buffer,this.spatialFilterByDrawing=new G({drawBoxOption:{map:this.map,geoTypes:b.drawing.geometryTypes},nls:this.nls,enableBuffer:!!f,distance:h.getObject("defaultDistance",!1,f)||0,unit:h.getObject("defaultUnit",
!1,f)||""}),this.own(k(this.spatialFilterByDrawing,"change",h.hitch(this,this._updateExecuteButtonStatus))),this.spatialFilterByDrawing.placeAt(this.drawingSection));if(b.useFeatures){f={value:"useFeatures",label:this.nls.useFeaturesTip};this.spatialTypeSelect.addOption(f);b.useFeatures["default"]&&this.spatialTypeSelect.set("value",f.value);f=b.useFeatures.buffer;var u=[];a.webMapLayerId&&u.push(a.webMapLayerId);this.spatialFilterByFeatures=new H({map:this.map,nls:this.nls,enableBuffer:!!f,distance:h.getObject("defaultDistance",
!1,f)||0,unit:h.getObject("defaultUnit",!1,f)||"",showLoading:!1,ignoredFeaturelayerIds:u});this.spatialFilterByFeatures.tipNode&&g.setStyle(this.spatialFilterByFeatures.tipNode,"display","block");this.spatialFilterByFeatures.placeAt(this.featuresSection);this.own(k(this.spatialFilterByFeatures,"loading",h.hitch(this,function(){this.domNode&&this.shelter.show()})));this.own(k(this.spatialFilterByFeatures,"unloading",h.hitch(this,function(){this.domNode&&this.shelter.hide()})));this.own(k(this.spatialFilterByFeatures,
"search-distance-change",h.hitch(this,this._updateExecuteButtonStatus)));(a=b.useFeatures.relationships)&&0<a.length?p.forEach(a,h.hitch(this,function(m){this.relationshipSelect.addOption({value:m.relationship,label:m.label})})):this.relationshipSelect.addOption({value:this._defaultRelationship,label:this._defaultRelationship})}b.fullLayerExtent&&(f={value:"fullLayerExtent",label:this.nls.noSpatialLimitTip},this.spatialTypeSelect.addOption(f),b.fullLayerExtent["default"]&&this.spatialTypeSelect.set("value",
f.value));a=!0;b=this.spatialTypeSelect.getOptions()||[];0===b.length?(a=!1,this.spatialFilterTip.innerHTML=this.nls.noSpatialLimitTip):1===b.length?(a="fullLayerExtent"!==b[0].value,this.spatialFilterTip.innerHTML=b[0].label,g.addClass(this.spatialTypeSelect.domNode,"not-visible"),g.setAttr(this.spatialSectionDiv,"tabindex","0")):a=!0;q.isTable(c)&&(a=!1);a?g.removeClass(this.spatialSectionDiv,"not-visible"):g.addClass(this.spatialSectionDiv,"not-visible");this._onSpatialTypeSelectChanged();d&&!a&&
g.removeClass(this.noFilterTip,"not-visible");c=this._getBestQueryName(e);this.layerNameTextBox.set("value",c)},getQueryResultName:function(){return this.layerNameTextBox.get("value")},_getConstantRelationship:function(){var a=this._defaultRelationship;"useFeatures"===this.spatialTypeSelect.get("value")&&(a=this.relationshipSelect.get("value"));return a},_getRestRelationship:function(){var a=this._getConstantRelationship();return I[a]},_onSpatialTypeSelectChanged:function(){var a=this.spatialTypeSelect.get("value");
"drawing"===a?g.setStyle(this.drawingSection,"display","block"):(g.setStyle(this.drawingSection,"display","none"),this._tryResetSpatialFilterByDrawing());"useFeatures"===a?g.setStyle(this.featuresSection,"display","block"):(g.setStyle(this.featuresSection,"display","none"),this._tryResetSpatialFilterByFeatures());this.spatialTypeSelect.domNode.title="";a&&(a=this.spatialTypeSelect.getOptions(a))&&(this.spatialTypeSelect.domNode.title=a.label);this._updateExecuteButtonStatus()},_tryResetSpatialFilterByDrawing:function(){this.spatialFilterByDrawing&&
this.spatialFilterByDrawing.reset()},_tryResetSpatialFilterByFeatures:function(){this.spatialFilterByFeatures&&this.spatialFilterByFeatures.reset()},_onBtnParamsBackClicked:function(){this._tryResetSpatialFilterByDrawing();this._tryResetSpatialFilterByFeatures();if("function"===typeof this.onBack)this.onBack()},_onBtnParamsBackKeydown:function(a){a.keyCode!==n.ENTER&&a.keyCode!==n.SPACE||this._onBtnParamsBackClicked()},_getBestQueryName:function(a){for(var c=a=a?a+(" _"+this.nls.queryResult):a+this.nls.queryResult,
d=p.map(this.map.graphicsLayerIds,h.hitch(this,function(b){return this.map.getLayer(b).name})),e=2;0<=p.indexOf(d,c);)c=a+"_"+e,e++;return c},_onLayerNameTextChanged:function(){this._updateExecuteButtonStatus()},_onBtnApplyClicked:function(){this._updateExecuteButtonStatus()&&this.run()},_onBtnApplyKeydown:function(a){a.keyCode!==n.ENTER&&a.keyCode!==n.SPACE||this._onBtnApplyClicked()},_showLayerNameContainer:function(){g.setStyle(this.layerNameContainer,"display","block")},_hideLayerNameContainer:function(){g.setStyle(this.layerNameContainer,
"display","none")},_showCriteiraLabelDiv:function(){g.setStyle(this.criteiraLabelDiv,"display","block")},_hideCriteiraLabelDiv:function(){g.setStyle(this.criteiraLabelDiv,"display","none")},_showSpatialFilterLabelDiv:function(){g.setStyle(this.spatialFilterLabelDiv,"display","block")},_hideSpatialFilterLabelDiv:function(){g.setStyle(this.spatialFilterLabelDiv,"display","none")}})});