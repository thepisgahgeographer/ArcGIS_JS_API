// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/Evented dojo/on dojo/string dojo/keys dojo/string dojo/dom-attr dojo/dom-style dojo/_base/lang dojo/_base/array dojo/dom-construct esri/graphic jimu/dijit/Message dijit/_WidgetBase ./presetUtils dojo/query esri/tasks/RelationshipQuery dojo/dom-geometry dojo/dom-class".split(" "),function(w,x,p,t,q,y,l,u,h,r,n,z,v,A,B,k,C,D,m){return w([A,x],{newRelatedFeature:{},_validRelations:[],isSaveEnable:!1,postCreate:function(){this._validRelations=[]},startup:function(){this._createTable()},
_createTable:function(){var b=n.create("div",{"class":"relatedTablesContainer"},this.domNode);r.forEach(this.relationshipInfo,h.hitch(this,function(a,e){a.featureLayer&&a.hasOwnProperty("relationshipId")&&this._createRelatedTableItem(a,b,e)}));0<k(".relatedTableTitleContainer",this.domNode).length?this.emit("addRelatedItemContent",!0):this.emit("addRelatedItemContent",!1)},_getKeyField:function(b){var a;var e=b;b=b.toLowerCase();for(a in this.parentFeature.attributes)if(b===a.toLowerCase()){e=a;break}return e},
_createRelatedTableItem:function(b,a,e){var c,d={};if(c=this.layerInfosObj.getLayerOrTableInfoById(b.featureLayer.id)){var f=n.create("div",{"class":"relatedTableTitleContainer"},a);l.set(f,"layerId",c.id);l.set(f,"relationshipId",b.relationshipId);l.set(f,"parentFeatureOID",this.parentFeature.attributes[this.parentFeature._layer.objectIdField]);p(f,"click",h.hitch(this,function(g){g=l.get(g.currentTarget,"relatedRecordCount");(null===g||g&&0!==parseInt(g,10))&&this.emit("titleClicked",c.id,b.relationshipId,
!1,this.parentFeatureIndexInAI,this.parentFeature.attributes[this.parentFeature._layer.objectIdField],this.newRelatedFeature[b.relationshipId].foreignKeyField)}));a=n.create("div",{"class":"relatedTableTitle esriCTEllipsis relatedTableFields",innerHTML:c.title,tabindex:"-1",title:c.title,"aria-label":c.title,role:"button"},f);p(a,"keydown",h.hitch(this,function(g){g.keyCode!==q.ENTER&&g.keyCode!==q.SPACE||f.click()}));n.create("div",{"class":"esriCTLoadingIcon hidden"},f);n.create("div",{"class":"esriCTRelatedTableRecordsCount"},
f);d=this._checkRelationShip(c,b.relationshipId);d.isValidRelation?(this._createNewGraphics(b.relationshipId,c.id,d.primaryKeyField,d.foreignKeyField),this._validRelations.push(b)):n.destroy(f);this._canAddFeatures(b,c)&&"Table"===c.layerObject.type?(a=t.substitute(this.nls.createNewFeatureLabel,{layerTitle:c.title}),a=n.create("div",{"class":"relatedTableIcons itemTitleCreateNew relatedTableFields",title:this.nls.addNewFeature,"aria-label":a,role:"button",tabindex:"-1"},f),l.set(a,"tableId",c.id),
p(a,"click",h.hitch(this,function(g){this._createNewButtonClick(g,b,c,f)})),p(a,"keydown",h.hitch(this,function(g){g.keyCode!==q.ENTER&&g.keyCode!==q.SPACE||this._createNewButtonClick(g,b,c,f)})),this.relationshipInfo.length-1===e&&m.add(a,"esriCTLastRelatedItem")):this.relationshipInfo.length-1===e&&m.add(a,"esriCTLastRelatedItem");d.isValidRelation&&this.getRelatedRecordsCount(b.relationshipId,c.id)}},_createNewButtonClick:function(b,a,e,c){b.stopPropagation();b=this.newRelatedFeature[a.relationshipId];
this.isSaveEnable?v({message:this.nls.pendingFeatureSaveMsg}):(this.parentFeature.attributes.hasOwnProperty(b.primaryKeyField)||(b.primaryKeyField=this._getKeyField(b.primaryKeyField)),void 0===this.parentFeature.attributes[b.primaryKeyField]||null===this.parentFeature.attributes[b.primaryKeyField]?(a=B.getFieldInfoByFieldName(this.parentFieldInfos,b.primaryKeyField).label||b.primaryKeyField,a=y.substitute(this.nls.invalidRelationShipMsg,{parentKeyField:a}),v({message:a})):(this.newRelatedFeature[a.relationshipId].attributes[this.newRelatedFeature[a.relationshipId].foreignKeyField]=
this.parentFeature.attributes[this.newRelatedFeature[a.relationshipId].primaryKeyField],this.emit("addRelatedRecord",this.newRelatedFeature[a.relationshipId],c,e.id,this.parentFeatureIndexInAI,this.newRelatedFeature[a.relationshipId].foreignKeyField)))},_canAddFeatures:function(b,a){a=a.layerObject.getEditCapabilities();return!b.allowUpdateOnly&&b._editFlag&&a.canCreate?!0:!1},_checkRelationShip:function(b,a){var e=!0;var c=this._getRelationShipById(this.parentFeature._layer,a);b=this._getRelationShipById(b.layerObject,
a);if(c&&c.keyField&&b&&b.keyField){var d=c.keyField;var f=b.keyField}else e=!1;return{isValidRelation:e,foreignKeyField:f,primaryKeyField:d}},_createNewGraphics:function(b,a,e,c){var d={};a=this.layerInfosObj.getLayerOrTableInfoById(a);0<a.layerObject.templates.length?d=a.layerObject.templates[0].prototype.attributes:0<a.layerObject.types.length&&(d=a.layerObject.types[0].templates[0].prototype.attributes);d=new z(null,null,h.clone(d));d.attributes.hasOwnProperty(c)&&(d.attributes[c]=this.parentFeature.attributes[e]);
this.newRelatedFeature[b]=d;this.newRelatedFeature[b].primaryKeyField=e;this.newRelatedFeature[b].foreignKeyField=c;this.newRelatedFeature[b].featureLayer=a;return!0},_getRelationShipById:function(b,a){var e;r.some(b.relationships,h.hitch(this,function(c){if(c.id===a)return e=c,!0}));return e},updateFeatureInstance:function(b){this.parentFeature&&(this.parentFeature.attributes=h.clone(b))},displayRelatedRecordCount:function(b,a){a=k("[relationshipid \x3d "+a+"]",this.domNode);var e=k(".relatedTableIcons.itemTitleCreateNew",
this.domNode);var c=k(".esriCTLoadingIcon",a[0])[0];m.add(c,"hidden");var d=k(".esriCTRelatedTableRecordsCount",a[0])[0];m.remove(d,"hidden");c=k(".relatedTableTitle",a[0])[0];l.set(d,"innerHTML","("+b+")");var f=t.substitute(this.nls.relatedFeatureCount,{layerTitle:c.innerHTML,featureCount:b});l.set(c,"aria-label",f);l.set(a[0],"relatedRecordCount",b);d=D.position(d).w;if("auto"===d||void 0===d||""===d||0===d)d=8+7*b.toString().length;d=0<e.length?d+35:d+10;u.set(c,"width","calc(100% - "+d+"px)");
0===b?m.add(a[0],"esriCTRelatedTableTitleDefaultCursor"):m.remove(a[0],"esriCTRelatedTableTitleDefaultCursor")},updateRelatedRecordsCount:function(){r.forEach(this._validRelations,h.hitch(this,function(b){this.getRelatedRecordsCount(b.relationshipId,b.featureLayer.id)}))},_showLoadingIndicator:function(b){var a=k("[relationshipid \x3d "+b+"]",this.domNode);b=k(".relatedTableIcons.itemTitleCreateNew",this.domNode);var e=k(".esriCTLoadingIcon",a[0])[0];var c=k(".esriCTRelatedTableRecordsCount",a[0])[0];
a=k(".relatedTableTitle",a[0])[0];m.remove(e,"hidden");m.add(c,"hidden");c=20;c=0<b.length?c+35:c+10;u.set(a,"width","calc(100% - "+c+"px)")},getRelatedRecordsCount:function(b,a){var e=this.parentFeature._layer;var c=this.parentFeature.attributes[this.parentFeature._layer.objectIdField];var d=new C;a=this.layerInfosObj.getLayerOrTableInfoById(a).layerObject.objectIdField;d.returnGeometry=!1;d.outSpatialReference=this.mapSpatialReference;d.relationshipId=b;d.objectIds=[c];d.outFields=[a];this._showLoadingIndicator(b);
e.queryRelatedFeatures(d,h.hitch(this,function(f){(f=f[c]&&f[c].features)?this.displayRelatedRecordCount(f.length,b):this.displayRelatedRecordCount(0,b)}),h.hitch(this,function(){this.displayRelatedRecordCount(0,b)}))}})});