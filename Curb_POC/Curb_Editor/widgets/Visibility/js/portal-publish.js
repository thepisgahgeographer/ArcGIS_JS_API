// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
require({cache:{"url:widgets/Visibility/templates/portal-publish.html":'\x3cdiv class\x3d"esriCTFullHeight" data-dojo-attach-point\x3d"resultsPageNode"\x3e\r\n  \x3cdiv class\x3d"esriCTFullWidth esriCTSettingHeader"\x3e\r\n    \x3cdiv class\x3d"esriCTBackButton" title\x3d"${nls.back}"\x3e\r\n      \x3cdiv class\x3d"esriCTItemLeftArrow" data-dojo-attach-point\x3d"resultsPanelBackButton" tabindex\x3d"0"\r\n        aria-label\x3d"${nls.back}" role\x3d"button"\x3e\x3c/div\x3e\r\n      \x3cdiv class\x3d"esriCTTitleDiv esriCTEllipsis" title\x3d"${nls.resultsTitle}"\x3e${nls.resultsTitle}\x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"esriCTMainPageRow"\x3e\r\n      \x3c!-- esriCT Layer Name --\x3e\r\n      \x3cdiv class\x3d"esriCTFullWidth esriCTSettingRow"\x3e\r\n        \x3cdiv class\x3d"esriCTInputLabel esriCTEllipsis" title\x3d"${nls.layerName}"\x3e${nls.layerName}\x3c/div\x3e\r\n        \x3cinput aria-label\x3d"${nls.layerName}" class\x3d"esriCTHidden" style\x3d"width: 100%; margin-bottom: 8px;"\r\n          data-dojo-type\x3d"dijit/form/ValidationTextBox" data-dojo-attach-point\x3d"addLayerNameArea"\r\n          data-dojo-props\x3d"regExp:\'[a-zA-Z0-9_ -]*\', invalidMessage:\'${nls.invalidLayerName}\', missingMessage:\'${nls.missingLayerNameMessage}\'"\r\n            required\x3d"true" tabindex\x3d"0" trim\x3d"true"\x3e\x3c/input\x3e\r\n        \x3cselect class\x3d"publishSelect" aria-label\x3d"${nls.layerName}" data-dojo-type\x3d"jimu/dijit/formSelect" tabindex\x3d"0"\r\n          data-dojo-attach-point\x3d"featureLayerList"\x3e\x3c/select\x3e\r\n        \x3cdiv class\x3d"esriCTCheckBoxNode" data-dojo-attach-point\x3d"checkBoxParentContainer"\x3e\x3c/div\x3e\r\n      \x3c/div\x3e\r\n      \x3c!-- Publish esriCT Button --\x3e\r\n      \x3cdiv class\x3d"esriCTPublishBtnContainer"\x3e\r\n        \x3cdiv class\x3d\'jimu-btn\' data-dojo-attach-point\x3d\'publishButton\' tabindex\x3d"0" aria-label\x3d"${nls.publishBtnLabel}"\r\n          role\x3d"button"\x3e${nls.publishBtnLabel}\x3c/div\x3e\r\n      \x3c/div\x3e\r\n\r\n      \x3c!-- Publishing Message --\x3e\r\n      \x3cdiv class\x3d"esriCTPublishMessage" data-dojo-attach-point\x3d"publishMessage"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e'}});
define("dojo/_base/declare jimu/BaseWidget dijit/_WidgetsInTemplateMixin jimu/dijit/CheckBox dojo/_base/array dojo/_base/lang dojo/json dojo/text!../templates/portal-publish.html dojo/dom-construct dojo/on dojo/dom-class dojo/dom-style esri/arcgis/Portal dojo/Evented ./portal-utils jimu/LayerInfos/LayerInfos esri/layers/FeatureLayer esri/graphic esri/dijit/util/busyIndicator jimu/utils dojo/keys dijit/focus dojo/query dojo/topic dijit/form/ValidationTextBox jimu/dijit/formSelect".split(" "),function(H,
I,J,K,q,c,z,L,M,p,h,N,O,P,r,A,B,C,Q,l,u,x,D,E){return H([I,J,P],{templateString:L,baseClass:"jimu-widget-visibility-publish",publishNewLayer:null,busyIndicator:null,fieldsObj:null,postCreate:function(){String.prototype.format||(String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,e){return"undefined"!==typeof a[e]?a[e]:b})});this.fieldsObj={RegionType:{value:"",dataType:"esriFieldTypeInteger"},CenterPoint:{value:this.centerPoint,dataType:"esriFieldTypeString"},
ObservationHeight:{value:this.observerHeight,dataType:"esriFieldTypeDouble"},HeightUnit:{value:this.observerHeightDD,dataType:"esriFieldTypeString"},MinObservationDistance:{value:this.minObsRange,dataType:"esriFieldTypeDouble"},MaxObservationDistance:{value:this.maxObsRange,dataType:"esriFieldTypeDouble"},DistanceUnit:{value:this.distanceUnitDD,dataType:"esriFieldTypeString"},FOVStartAngle:{value:this.fovStartAngle,dataType:"esriFieldTypeDouble"},FOVEndAngle:{value:this.fovEndAngle,dataType:"esriFieldTypeDouble"},
AngleUnits:{value:this.angleUnits,dataType:"esriFieldTypeString"}};this.fields={RegionType:"",CenterPoint:this.centerPoint,ObservationHeight:this.observerHeight,HeightUnit:this.observerHeightDD,MinObservationDistance:this.minObsRange,MaxObservationDistance:this.maxObsRange,DistanceUnit:this.distanceUnitDD,FOVStartAngle:this.fovStartAngle,FOVEndAngle:this.fovEndAngle,AngleUnits:this.angleUnits};this.publishNewLayer=new K({checked:!1,label:this.nls.publishToNewLayer},M.create("div",{},this.checkBoxParentContainer));
this.own(p(this.publishNewLayer,"change",c.hitch(this,this._onCheckboxClicked)));this._populateSelectList(this.featureLayerList,this._layerList,!0);0===this.featureLayerList.options.length&&(this.publishNewLayer.setValue(!0),h.add(this.checkBoxParentContainer,"esriCTHidden"));!this.config.hasOwnProperty("operationalLayer")||this.config.hasOwnProperty("operationalLayer")&&this.config.operationalLayer.hasOwnProperty("name")&&""===this.config.operationalLayer.name?(h.add(this.featureLayerList.domNode,
"esriCTHidden"),this.publishNewLayer.setValue(!0),h.remove(this.addLayerNameArea.domNode,"esriCTHidden")):(h.remove(this.featureLayerList.domNode,"esriCTHidden"),this.publishNewLayer.setValue(!1),h.add(this.addLayerNameArea.domNode,"esriCTHidden"));this.own(p(this.resultsPanelBackButton,"click",c.hitch(this,function(){this.emit("displayMainPageOnBack")})));this.own(p(this.resultsPanelBackButton,"keydown",c.hitch(this,function(a){a.keyCode!==u.ENTER&&a.keyCode!==u.SPACE||this.emit("displayMainPageOnBack")})));
this.own(p(this.publishButton,"click",c.hitch(this,function(){if(this.publishNewLayer.checked&&!this.addLayerNameArea.isValid())this.publishMessage.innerHTML=this.nls.missingLayerNameMessage;else{this.publishMessage.innerHTML="";var a={layerName:this.publishNewLayer.checked?this.addLayerNameArea.value:this.featureLayerList.getValue(),url:"",itemId:"",serviceItemId:""};if(!this.publishNewLayer.checked){var b=this._layerList.filter(function(e){return e.name===a.layerName},this);1===b.length&&(a.url=
b[0].url,a.itemId=b[0].id,a.serviceItemId=z.parse(b[0]._json).serviceItemId)}this._initSaveToPortal(a)}})));this.own(p(this.publishButton,"keydown",c.hitch(this,function(a){if(a.keyCode===u.ENTER||a.keyCode===u.SPACE)if(this.publishNewLayer.checked&&!this.addLayerNameArea.isValid())this.publishMessage.innerHTML=this.nls.missingLayerNameMessage,this._setFirstLastFocusNodes();else{this.publishMessage.innerHTML="";var b={layerName:this.publishNewLayer.checked?this.addLayerNameArea.value:this.featureLayerList.getValue(),
url:"",itemId:"",serviceItemId:"",map:this.map,appConfig:this.appConfig,renderer:this._renderer,publishMessage:this.publishMessage,nls:this.nls,graphics:this.ThreatArea.graphics};this.publishNewLayer.checked||(a=this._layerList.filter(function(e){return e.name===b.layerName},this),1===a.length&&(b.url=a[0].url,b.itemId=a[0].id,b.serviceItemId=z.parse(a[0]._json).serviceItemId));this._initSaveToPortal(b)}})));this.own(E.subscribe("WIDGET_RESIZE",c.hitch(this,this._onWidgetResize)));this.own(p(this.featureLayerList,
"change",c.hitch(this,function(){this._onWidgetResize()})))},startup:function(){this.busyIndicator=Q.create({target:this.parentNode.parentNode.parentNode.parentNode,backgroundOpacity:0})},_onWidgetResize:function(){var a=D(".dijitValidationTextBoxLabel",this.featureLayerList.domNode);0<a.length&&N.set(a[0],"width",this.publishButton.clientWidth-53+"px")},_onCheckboxClicked:function(){this.publishNewLayer.checked?(h.add(this.featureLayerList.domNode,"esriCTHidden"),h.remove(this.addLayerNameArea.domNode,
"esriCTHidden"),this.addLayerNameArea.reset(),this.addLayerNameArea.focus()):(h.add(this.addLayerNameArea.domNode,"esriCTHidden"),h.remove(this.featureLayerList.domNode,"esriCTHidden"));this._addLayerToMap=this.publishNewLayer.checked},_containsSupportedCapabilities:function(a){var b=!0;["create","delete","query","update","editing"].forEach(function(e){-1===a.toLowerCase().split(",").indexOf(e)&&(b=!1)});return b},_populateSelectList:function(a,b,e){var f=[];e&&(f=q.filter(b,function(d){return"esriGeometryPolygon"===
d.geometryType},this));b=0<f.length?f:b;q.forEach(b,c.hitch(this,function(d){d.url&&"Feature Layer"===d.type&&this._containsSupportedCapabilities(d.capabilities)&&a.addOption({value:d.name,label:l.sanitizeHTML(d.name),selected:!1,id:d.id})}));this.config.hasOwnProperty("operationalLayer")&&this.config.operationalLayer.hasOwnProperty("name")&&""!==this.config.operationalLayer.name?a.setValue(this.config.operationalLayer.name):a.setValue("")},_toLowerCaseProps:function(a){for(var b,e=Object.keys(a),
f=e.length,d={};f--;)b=e[f],d[b.toLowerCase()]=a[b];return d},_initSaveToPortal:function(a){var b=a.layerName,e=new O.Portal(this.appConfig.portalUrl);this.own(p(e,"load",c.hitch(this,function(){e.signIn().then(c.hitch(this,function(f){var d=f.credential.token,m=f.orgId,v=f.username;if("org_user"===f.role)this.publishMessage.innerHTML=l.sanitizeHTML(this.nls.createService.format(this.nls.userRole)),this._setFirstLastFocusNodes();else if(a.url){f=new B(a.url+"?token\x3d"+d,{id:a.layerName,outFields:["*"]});
f._wabProperties={itemLayerInfo:{portalUrl:this.appConfig.portalUrl,itemId:a.itemId}};this.busyIndicator.show();var F=[];this.graphics.forEach(function(n){if(void 0!==n.attributes&&n.attributes.hasOwnProperty("type")){var g=c.clone(this.fields);g.RegionType="visible"===n.attributes.regionType?1:0;g=e.isPortal?this._toLowerCaseProps(g):g;F.push(new C(n.geometry,null,g))}},this);f.applyEdits(F,null,null).then(c.hitch(this,function(){E.publish("moveMap",!1);this.publishMessage.innerHTML=this.nls.successfullyPublished.format('\x3cbr /\x3e\x3ca href\x3d"'+
this.appConfig.portalUrl+"home/item.html?id\x3d"+a.serviceItemId+'" target\x3d"_blank"\x3e')+"\x3c/a\x3e";this._reset()})).otherwise(c.hitch(this,function(n){this.publishMessage.innerHTML=n.message;this._reset()}));this.busyIndicator.hide();this._setFirstLastFocusNodes()}else{var R=this.appConfig.portalUrl+"sharing/content/users/"+v+"/createService";r.isNameAvailable(this.appConfig.portalUrl+"sharing/rest/portals/"+m+"/isServiceNameAvailable",d,b).then(c.hitch(this,function(n){n.available?(this.busyIndicator.show(),
r.createFeatureService(R,d,r.getFeatureServiceParams(b,this.map)).then(c.hitch(this,function(g){if(g.success){var S=g.serviceurl.replace(/rest/g,"rest/admin")+"/addToDefinition";r.addDefinitionToService(S,d,r.getLayerParams(b,this.map,this._renderer,this.nls)).then(c.hitch(this,function(k){if(k.success){k=new B(g.serviceurl+"/0?token\x3d"+d,{id:b,outFields:["*"]});k._wabProperties={itemLayerInfo:{portalUrl:this.appConfig.portalUrl,itemId:g.itemId}};this.map.addLayer(k);if(k.loaded){var y=A.getInstanceSync().getLayerInfoById(b);
y.enablePopup()}else k.on("load",c.hitch(this,function(){y=A.getInstanceSync().getLayerInfoById(b);y.enablePopup()}));var G=[];q.forEach(this.graphics,function(w){if(void 0!==w.attributes&&w.attributes.hasOwnProperty("type")){var t=c.clone(this.fields);t.RegionType="visible"===w.attributes.regionType?1:0;t=e.isPortal?this._toLowerCaseProps(t):t;G.push(new C(w.geometry,null,t))}},this);k.applyEdits(G,null,null).then(c.hitch(this,function(){this._reset()})).otherwise(c.hitch(this,function(){this._reset()}));
this.busyIndicator.hide();this.publishMessage.innerHTML=this.nls.successfullyPublished.format('\x3cbr /\x3e\x3ca role\x3d"link" tabindex\x3d0 aria-label\x3d"'+this.nls.successfullyPublished+'" href\x3d"'+this.appConfig.portalUrl+"home/item.html?id\x3d"+g.itemId+'" target\x3d"_blank"\x3e')+"\x3c/a\x3e";this._setFirstLastFocusNodes()}}),c.hitch(this,function(k){this.busyIndicator.hide();this.publishMessage.innerHTML=l.sanitizeHTML(this.nls.addToDefinition.format(k.message));this._setFirstLastFocusNodes()}))}else this.busyIndicator.hide(),
this.publishMessage.innerHTML=l.sanitizeHTML(this.nls.unableToCreate.format(b)),this._setFirstLastFocusNodes()}),c.hitch(this,function(g){this.busyIndicator.hide();this.publishMessage.innerHTML=l.sanitizeHTML(this.nls.createService.format(g.message));this._setFirstLastFocusNodes()}))):(this.busyIndicator.hide(),this.publishMessage.innerHTML=this.nls.layerNameExists)}))}}),c.hitch(this,function(f){this.busyIndicator.hide();this.publishMessage.innerHTML=f.message;this._setFirstLastFocusNodes()}))})))},
_reset:function(){this.graphicsLayer.clear();this.graphics=[];this.graphicsLayer.refresh()},_setFirstLastFocusNodes:function(){l.initFirstFocusNode(this.parentNode,this.resultsPanelBackButton);x.focus(this.resultsPanelBackButton);l.initLastFocusNode(this.parentNode,this.publishButton);var a=D("a",this.publishMessage)[0];""!==this.publishMessage.innerHTML&&a?(l.initLastFocusNode(this.parentNode,this.publishMessage),x.focus(a)):""===this.publishMessage.innerHTML&&x.focus(this.resultsPanelBackButton)},
_matchLayerFields:function(a,b){var e={},f=Object.keys(this.fieldsObj);q.forEach(b,c.hitch(this,function(d){q.forEach(f,c.hitch(this,function(m){if(d.name.toLowerCase()===m.toLowerCase()&&(d.type===this.fieldsObj[m].dataType||"esriFieldTypeString"===d.type)){var v=this.fieldsObj[m].value;"esriFieldTypeString"===d.type&&50>d.length&&"string"===typeof this.fieldsObj[m].value&&(v=this.fieldsObj[m].value.substr(0,d.length));e[d.name]="RegionType"===m?a:v}}))}));return e}})});